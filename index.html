<!DOCTYPE html>
<html lang="vi">
<head>
 <meta charset="UTF-8">
 <title>Quản Lý Kim Cương</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <style>
 :root {
 --primary-color: #4f46e5;
 --danger-color: #ff6b6b;
 --success-color: #10b981;
 --warning-color: #f59e0b;
 --info-color: #3b82f6; 
 --background-dark1: #1a1a2e;
 --background-dark2: #16213e;
 --background-dark3: #0f3460;
 --white: #ffffff;
 --light-gray: #f8f9fa;
 --medium-gray: #e0e6ed;
 --dark-gray: #374151;
 --text-color: #333;
 }
 
 * { box-sizing: border-box; }
 
 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
 margin: 0; padding: 0;
 background: linear-gradient(135deg, var(--background-dark1) 0%, var(--background-dark2) 50%, var(--background-dark3) 100%);
 min-height: 100vh; color: var(--text-color);
 }

 .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
 .header { text-align: center; margin-bottom: 30px; color: var(--white); }
 .header h2 { font-size: 2.5rem; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 700; }
 .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1rem; }

 .card {
 background: var(--white); border-radius: 20px; padding: 30px;
 margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray); transition: transform 0.2s ease, box-shadow 0.2s ease;
 }
 .card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
 .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
 .form-section input[type="text"], .form-section input[type="number"], .controls-section input[type="search"] {
 width: 100%; padding: 16px 20px; font-size: 16px;
 border: 2px solid #e1e5e9; border-radius: 12px;
 background: var(--white); transition: all 0.3s ease; outline: none;
 }
 .form-section input:focus, .controls-section input:focus {
 border-color: var(--primary-color);
 box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
 transform: translateY(-1px);
 }
 .form-section input::placeholder, .controls-section input::placeholder { color: #a0a8b0; }
 .form-buttons, .controls-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
 .btn {
 flex: 1; min-width: 160px; padding: 16px 24px; font-size: 16px;
 font-weight: 600; border: none; border-radius: 12px; cursor: pointer;
 transition: all 0.3s ease; text-decoration: none; display: inline-flex;
 align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden;
 }
 .btn::before {
 content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
 background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
 transition: left 0.5s;
 }
 .btn:hover::before { left: 100%; }
 .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
 .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4); }
 .btn-danger { background: linear-gradient(135deg, var(--danger-color), #ee5a52); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
 .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }
 .btn-secondary { background: linear-gradient(135deg, #64748b, #475569); color: white; box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3); }
 .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4); }
 .btn-info { background: linear-gradient(135deg, var(--info-color), #2563eb); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
 .btn-info:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }

 .server-section {
 background: var(--white); border-radius: 20px; margin-bottom: 25px;
 overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray); transition: transform 0.2s ease;
 }
 .server-section:hover { transform: translateY(-2px); }
 .server-header {
 background: linear-gradient(135deg, #1f2937, var(--dark-gray)); color: white;
 padding: 20px 30px; font-size: 1.3rem; font-weight: 600;
 display: flex; align-items: center; justify-content: space-between; gap: 10px;
 }
 .server-stats {
 background: var(--primary-color); padding: 8px 16px; border-radius: 20px;
 font-size: 1.1rem; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
 cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease;
 }
 .server-stats:hover {
    transform: scale(1.05);
    background: #5a52e8;
 }

 table { width: 100%; border-collapse: collapse; font-size: 15px; background: var(--white); }
 th, td { padding: 16px 10px; text-align: center; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
 th { background: var(--light-gray); color: #555; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
 tbody tr { transition: background-color 0.2s ease; }
 tbody tr:hover { background: var(--light-gray); }

 .account-name.clickable { 
    font-weight: 600; 
    color: var(--primary-color);
    cursor: pointer;
    border-radius: 8px;
 }
 .account-name.clickable:hover {
    background-color: #f0f8ff;
    text-decoration: underline;
 }

 .diamond-count {
 font-weight: 700; color: var(--primary-color); font-size: 1.1rem;
 cursor: pointer; border-radius: 8px; transition: background-color 0.2s ease;
 }
 .diamond-count:hover { background-color: #f0f8ff; }
 .diamond-count input {
 width: 100px; text-align: center; border: 1px solid var(--primary-color);
 border-radius: 5px; padding: 5px; font-size: 1rem; font-weight: 700;
 }
 .income-expense { font-size: 0.9rem; font-weight: 600; }
 .change-positive { color: var(--success-color); }
 .change-negative { color: var(--danger-color); }

 /* === CSS CHO VỊ TRÍ (ĐÃ CẬP NHẬT) === */
 .location-cell { 
    min-width: 120px; max-width: 200px; word-break: break-word; color: #555;
 }
 .location-primary, .location-secondary {
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
 }
 .location-primary:hover, .location-secondary:hover {
    background-color: #f0f8ff;
    text-decoration: underline;
 }
 .location-cell .placeholder { opacity: 0.6; font-style: italic; }

 /* === CSS CHO DROPDOWN VỊ TRÍ (ĐÃ CẬP NHẬT) === */
 #customLocationDropdown {
    display: none;
    position: absolute;
    z-index: 1001;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 200px;
    overflow: hidden; /* Bỏ overflow-y, để list tự scroll */
 }
 #customLocationDropdown.show { display: block; }
 .location-dropdown-header {
    padding: 8px;
    border-bottom: 1px solid #eee;
    background-color: #f8f9fa;
 }
 .location-dropdown-header input {
    width: 100%;
    padding: 8px 10px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    outline: none;
 }
 .location-dropdown-list {
    max-height: 180px;
    overflow-y: auto;
    padding: 0; margin: 0;
    list-style: none;
 }
 .location-dropdown-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.9rem;
 }
 .location-dropdown-list li:hover { background-color: var(--light-gray); }
 .location-dropdown-list .delete-suggestion-btn {
    color: var(--danger-color);
    padding: 4px;
    border-radius: 50%;
    font-size: 0.9rem;
    line-height: 1;
    margin-left: 10px;
 }
 .location-dropdown-list .delete-suggestion-btn:hover { background-color: #ffeded; }
 .location-dropdown-list .empty-list {
    padding: 15px;
    text-align: center;
    color: #888;
    font-style: italic;
 }

 .action-buttons { display: flex; gap: 8px; justify-content: center; align-items: center; }
 .btn-small {
 width: 36px; height: 36px; padding: 8px; font-size: 14px;
 border: none; border-radius: 8px; cursor: pointer;
 transition: all 0.2s ease; font-weight: 500;
 display: inline-flex; align-items: center; justify-content: center;
 }
 .btn-check { background-color: var(--success-color); color: white; }
 .btn-check:hover { background: #0e9f6e; transform: scale(1.05); }
 .btn-sync { background-color: var(--info-color); color: white; }
 .btn-sync:hover { background: #2563eb; transform: scale(1.05); }
 .btn-history { background-color: #64748b; color: white; }
 .btn-history:hover { background: #475569; transform: scale(1.05); }
 .btn-edit { background: var(--warning-color); color: white; }
 .btn-edit:hover { background: #d97706; transform: scale(1.05); }
 .btn-delete { background: var(--danger-color); color: white; }
 .btn-delete:hover { background: #ee5a52; transform: scale(1.05); }
 
 .toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
 }
 .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
 }
 .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--danger-color);
    transition: .4s;
    border-radius: 24px;
 }
 .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
 }
 input:checked + .slider {
    background-color: var(--success-color);
 }
 input:checked + .slider:before {
    transform: translateX(20px);
 }

 .empty-state {
 text-align: center; padding: 60px 20px; background: var(--white);
 border-radius: 20px; color: #666;
 }
 .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; color: var(--primary-color); }
 #toast-container {
 position: fixed; top: 20px; right: 20px; z-index: 9999;
 display: flex; flex-direction: column; gap: 10px;
 }
 .toast {
 background-color: var(--dark-gray); color: white; padding: 15px 20px;
 border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
 display: flex; align-items: center; gap: 10px; opacity: 0;
 transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
 }
 .toast.show { opacity: 1; transform: translateX(0); }
 .toast.toast-success { background-color: var(--success-color); }
 .toast.toast-danger { background-color: var(--danger-color); }
 .toast.toast-info { background-color: var(--info-color); }
 .modal {
 position: fixed; z-index: 1000; left: 0; top: 0;
 width: 100%; height: 100%; overflow: auto;
 background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
 display: none; align-items: center; justify-content: center;
 }
 .modal.active { display: flex; }
 .modal-content {
 background-color: #fefefe; margin: auto; padding: 20px;
 border: 1px solid #888; width: 90%; max-width: 700px;
 border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s;
 }
 .modal-header {
 padding: 10px 15px; border-bottom: 1px solid #e5e5e5;
 display: flex; justify-content: space-between; align-items: center;
 }
 .modal-header h2 { margin: 0; font-size: 1.5rem; }
 .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
 .close-btn:hover, .close-btn:focus { color: black; }
 .modal-body { padding: 15px; max-height: 70vh; overflow-y: auto;}
 #noteModal .modal-body { display: flex; flex-direction: column; gap: 15px; }
 #noteModal #noteModalInfo { font-size: 1.1rem; text-align: center; }
 #noteModal #noteInputGroup { display: flex; gap: 10px; }
 #noteModal #noteInput {
    flex-grow: 1; padding: 12px; font-size: 1rem;
    border-radius: 8px; border: 1px solid #ccc;
 }
 #noteModal #noteOtherBtn {
    flex-shrink: 0; padding: 0 15px;
 }
 #noteModal #noteAltOptions { display: none; gap: 10px; justify-content: center; }
 #noteModal #noteAltOptions .btn { flex: 1; }
 .modal-actions {
    display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px;
    border-top: 1px solid #e5e5e5;
 }
 .modal-actions .btn { min-width: 120px; flex: 0; }
 #historyModal .lifetime-stats {
    padding: 15px; margin-bottom: 15px; background: var(--light-gray);
    border-radius: 10px; text-align: center; display: flex;
    justify-content: space-around; font-size: 1.1rem;
 }
 #historyModal .stat-item span { display: block; font-weight: 700; }
 #historyModal .stat-item .change-positive { font-size: 1.3rem; }
 #historyModal .stat-item .change-negative { font-size: 1.3rem; }
 .history-table { width: 100%; border-collapse: collapse; }
 .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
 .history-table th { background-color: #f2f2f2; }
 .history-table .note-col { max-width: 200px; word-wrap: break-word; }
 .history-table .type-check td { color: #888; font-style: italic; }

 #notesList { list-style: none; padding: 0; margin: 0; }
 #notesList li { 
    display: flex; align-items: flex-start; gap: 15px;
    padding: 12px; border-bottom: 1px solid #eee;
 }
 #notesList li:last-child { border-bottom: none; }
 #notesList .note-content { flex-grow: 1; }
 #notesList .note-text { 
    display: block; margin-bottom: 5px; white-space: pre-wrap;
    cursor: pointer; border-radius: 5px; padding: 2px;
}
 #notesList .note-text:hover { background-color: #f0f8ff; }
 #notesList .note-timestamp { font-size: 0.8rem; color: #888; }
 #notesList .note-actions { display: flex; gap: 8px; }
 #newNoteSection { margin-top: 20px; border-top: 1px solid #e5e5e5; padding-top: 20px; }
 #newNoteSection textarea {
    width: 100%; min-height: 80px; padding: 10px; font-size: 1rem;
    border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px;
 }
 .history-table .note-col.editable { cursor: pointer; }
 .history-table .note-col.editable:hover { background-color: #f0f8ff; }
 .history-table .note-col input, #notesList .note-content textarea {
    width: 100%; padding: 6px; font-size: 0.95rem; text-align: left;
    border: 1px solid var(--info-color); border-radius: 5px; background: #f0f8ff;
    resize: vertical;
 }

 @media (max-width: 768px) {
 .container { padding: 15px; }
 .header h2 { font-size: 2rem; }
 .card { padding: 20px; border-radius: 16px; }
 .input-group, .controls-section { grid-template-columns: 1fr; gap: 15px; }
 .form-buttons, .controls-buttons { flex-direction: column; }
 .btn { min-width: auto; }
 .server-header { padding: 15px 20px; font-size: 1.1rem; flex-direction: column; align-items: stretch; gap: 8px; }
 .server-stats { text-align: center; }
 th, td { padding: 12px 5px; font-size: 13px; }
 .action-buttons { flex-wrap: wrap; }
 #toast-container { top: 10px; right: 10px; left: 10px; }
 .toast { width: 100%; }
 .modal-content { width: 95%; max-width: 450px; }
 #historyModal .lifetime-stats { flex-direction: column; gap: 10px; }
 }
 @media (max-width: 480px) {
    th, td { font-size: 12px; }
    .action-buttons { gap: 4px; }
    .btn-small { width: 32px; height: 32px; }
 }
 .fade-in { animation: fadeIn 0.4s ease-in-out; }
 @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
 </style>
</head>
<body>
<div id="customLocationDropdown"></div>

<div class="container">
    <div class="header">
        <h2><i class="fa-regular fa-gem"></i> Diamonds Lineage2M</h2>
        <p>Theo dõi và quản lý kim cương của bạn một cách dễ dàng</p>
    </div>
    <div class="card form-section">
        <input type="hidden" id="editIndex" value="">
        <div class="input-group">
            <input type="text" id="account" placeholder="Tên account">
            <input type="text" id="server" placeholder="Server (ví dụ: B9, L9)" list="server-list">
            <datalist id="server-list"></datalist>
            <input type="number" id="current" placeholder="Kim cương khởi tạo">
        </div>
        <div class="form-buttons">
            <button class="btn btn-primary" onclick="addOrUpdate()"><i class="fa-solid fa-save"></i> Lưu / Cập nhật</button>
            <button class="btn btn-info" onclick="clearForm()"><i class="fa-solid fa-eraser"></i> Hủy / Làm mới</button>
            <button class="btn btn-danger" onclick="resetAll()"><i class="fa-solid fa-trash-alt"></i> Xoá tất cả</button>
        </div>
    </div>
    <div class="card controls-section">
        <input type="search" id="searchInput" placeholder="Tìm theo tên account, server hoặc vị trí..." onkeyup="handleSearch()">
        <div class="controls-buttons">
            <button id="sortToggleBtn" class="btn btn-secondary" onclick="toggleSortOrder()"><i class="fa-solid fa-clock"></i> Sắp xếp theo Thời gian</button>
            <button class="btn btn-secondary" onclick="triggerImport()"><i class="fa-solid fa-file-import"></i> Nhập Dữ Liệu (JSON)</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
        </div>
    </div>
    <div id="serverTables"></div>
    <div id="toast-container"></div>
    
    <div id="historyModal" class="modal">
        <div class="modal-content"><div class="modal-header"><h2 id="historyModalTitle">Lịch sử giao dịch</h2><div><button id="exportHistoryBtn" class="btn btn-info" style="min-width: unset; padding: 8px 15px;"><i class="fa-solid fa-file-export"></i> Xuất JSON</button><span class="close-btn" onclick="closeHistoryModal()" style="margin-left: 15px;">×</span></div></div><div class="modal-body"><div class="lifetime-stats"><div class="stat-item">Tổng Thu Trọn Đời<span id="lifetimeIncome" class="change-positive"></span></div><div class="stat-item">Tổng Chi Trọn Đời<span id="lifetimeExpense" class="change-negative"></span></div></div><table class="history-table"><thead><tr><th>Thời gian</th><th>Thay đổi</th><th class="note-col">Ghi chú</th><th>Số dư sau GD</th></tr></thead><tbody id="historyTableBody"></tbody></table></div></div>
    </div>
    
    <div id="noteModal" class="modal">
        <div class="modal-content"><div class="modal-header"><h2>Ghi chú thay đổi</h2><span class="close-btn" onclick="closeNoteModal()">×</span></div><div class="modal-body"><p id="noteModalInfo"></p><div id="noteInputGroup"><input type="text" id="noteInput" placeholder="Nhập ghi chú..."><button id="noteOtherBtn" class="btn btn-secondary" onclick="showAltNoteOptions()">Khác...</button></div><div id="noteAltOptions"><button class="btn btn-secondary" onclick="setNoteAndConfirm('Chuyển Kim Cương')">Chuyển KC</button><button class="btn btn-warning" onclick="setNoteAndConfirm('Bán Kim Cương')">Bán KC</button></div></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeNoteModal()">Hủy</button><button class="btn btn-primary" onclick="confirmNoteChange()">Xác nhận</button></div></div>
    </div>

    <div id="serverStatsModal" class="modal">
        <div class="modal-content"><div class="modal-header"><h2 id="serverStatsModalTitle">Thống kê Server</h2><span class="close-btn" onclick="closeServerStatsModal()">×</span></div><div class="modal-body" id="serverStatsBody"></div></div>
    </div>

    <div id="accountNotesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="accountNotesModalTitle">Ghi chú</h2>
                <span class="close-btn" onclick="closeAccountNotesModal()">×</span>
            </div>
            <div class="modal-body">
                <ul id="notesList"></ul>
                <div id="newNoteSection">
                    <textarea id="newNoteInput" placeholder="Thêm ghi chú mới..."></textarea>
                    <button class="btn btn-primary" style="flex: unset; min-width: 120px;" onclick="addNewAccountNote()">Thêm ghi chú</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let data = [];
let sortOrder = 'diamonds';
let _noteModalState = {};
let _accountNotesModalState = {};

function migrateData(loadedData) {
    let needsSave = false;
    if (!Array.isArray(loadedData)) {
        loadedData = [];
    }
    loadedData.forEach(item => {
        if (!item.hasOwnProperty('history')) {
            item.history = []; needsSave = true;
        }
        if (!item.hasOwnProperty('performanceResetTimestamp')) {
            item.performanceResetTimestamp = null; needsSave = true;
        }
        if (typeof item.location === 'string' || item.location === undefined || item.location === null) {
            item.location = { primary: item.location || '', secondary: '' };
            needsSave = true;
        }
        if (!item.hasOwnProperty('status')) {
            item.status = 'on'; needsSave = true;
        }
        if (!item.hasOwnProperty('notes')) {
            item.notes = []; needsSave = true;
        }
    });
    return { migratedData: loadedData, needsSave };
}

function save() {
    try {
        localStorage.setItem("kimcuong_data_v3", JSON.stringify(data));
    } catch (e) {
        console.error("Lỗi khi lưu dữ liệu vào localStorage:", e);
        showToast("Lỗi khi lưu dữ liệu!", "danger");
    }
}

function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const iconClassMap = { success: 'fa-check-circle', danger: 'fa-times-circle', info: 'fa-info-circle' };
    toast.innerHTML = `<i class="fa-solid ${iconClassMap[type]}"></i> ${message}`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

function calculateIncomeExpense(history, resetTimestamp = null) {
    let income = 0; let expense = 0; if (!history) return { income, expense };
    const startDate = resetTimestamp ? new Date(resetTimestamp) : new Date(0);
    history.forEach(entry => {
        if (new Date(entry.timestamp) >= startDate) {
            if (entry.type !== 'check' && entry.oldBalance !== entry.newBalance) {
                const change = entry.newBalance - entry.oldBalance;
                if (change > 0) income += change;
                else if (change < 0) expense += Math.abs(change);
            }
        }
    });
    return { income, expense };
}

function formatRelativeTime(isoTimestamp) {
    if (!isoTimestamp) return 'Chưa có';
    const now = new Date(); const updateTime = new Date(isoTimestamp);
    const diffSeconds = Math.floor((now - updateTime) / 1000);
    if (diffSeconds < 60) return `${diffSeconds} giây trước`;
    const diffMinutes = Math.floor(diffSeconds / 60);
    if (diffMinutes < 60) return `${diffMinutes} phút trước`;
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours} giờ ${diffMinutes % 60} phút trước`;
    const f = (n) => String(n).padStart(2, '0');
    return `Lúc ${f(updateTime.getHours())}h${f(updateTime.getMinutes())}' ${f(updateTime.getDate())}/${f(updateTime.getMonth() + 1)}/${updateTime.getFullYear()}`;
}

function manualUpdateTimestamp(index) {
    const item = data[index]; if (!item) return;
    if (confirm(`Bạn có chắc muốn làm mới thời gian cập nhật cho tài khoản "${item.account}" không?`)) {
        item.history.unshift({ timestamp: new Date().toISOString(), type: 'check', amount: 0, note: 'Kiểm tra thủ công', oldBalance: item.current, newBalance: item.current });
        if (item.history.length > 200) item.history.pop();
        save(); render();
        showToast(`Đã ghi nhận lần kiểm tra cho ${item.account}`, 'info');
    }
}

function toggleSortOrder() {
    sortOrder = (sortOrder === 'diamonds') ? 'time' : 'diamonds';
    render();
}

function toggleAccountStatus(index, event) {
    event.stopPropagation();
    const item = data[index];
    item.status = (item.status === 'on') ? 'off' : 'on';
    save();
    showToast(`Đã chuyển trạng thái của ${item.account} thành ${item.status.toUpperCase()}`, 'info');
    render();
}

function render(dataToRender = data) {
    try {
        const serverTables = document.getElementById("serverTables"); serverTables.innerHTML = "";
        const existingServers = [...new Set(data.map(item => item.server))];
        document.getElementById('server-list').innerHTML = existingServers.map(s => `<option value="${s}"></option>`).join('');
        const grouped = dataToRender.reduce((acc, item) => { (acc[item.server] = acc[item.server] || []).push(item); return acc; }, {});
        if (Object.keys(grouped).length === 0) {
            const searchTerm = document.getElementById('searchInput').value;
            const emptyText = searchTerm ? `Không tìm thấy kết quả nào cho "<b>${searchTerm}</b>"` : `<div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div><div class="empty-state-text">Chưa có dữ liệu nào</div><div class="empty-state-subtext">Hãy thêm account đầu tiên của bạn</div>`;
            serverTables.innerHTML = `<div class="empty-state">${emptyText}</div>`;
        } else {
            Object.keys(grouped).sort().forEach(server => {
                const sortBtn = document.getElementById('sortToggleBtn');
                if (sortBtn) sortBtn.innerHTML = (sortOrder === 'diamonds') ? '<i class="fa-solid fa-clock"></i> Sắp xếp theo Thời gian' : '<i class="fa-regular fa-gem"></i> Sắp xếp theo Kim cương';
                if (sortOrder === 'diamonds') { grouped[server].sort((a, b) => b.current - a.current); } else { grouped[server].sort((a, b) => (new Date(b.history[0]?.timestamp || 0)) - (new Date(a.history[0]?.timestamp || 0))); }
                const rows = grouped[server].map(item => {
                    const originalIndex = data.findIndex(x => x.account === item.account && x.server === item.server);
                    const { income, expense } = calculateIncomeExpense(item.history, item.performanceResetTimestamp);
                    const lastUpdatedTimestamp = item.history && item.history.length > 0 ? item.history[0].timestamp : null;
                    
                    const loc = item.location || { primary: '', secondary: '' };
                    const primaryLocationHTML = loc.primary ? loc.primary : '<span class="placeholder">Chính</span>';
                    const secondaryLocationHTML = loc.secondary ? loc.secondary : (loc.primary ? '' : '<span class="placeholder">Phụ</span>');
                    const separator = loc.primary && loc.secondary ? ' / ' : '';
                    
                    const locationDisplay = `
                        <span class="location-primary" title="Chỉnh sửa vị trí chính">${primaryLocationHTML}</span>
                        ${separator ? `<span class="location-separator">${separator}</span>` : ''}
                        <span class="location-secondary" title="Chỉnh sửa vị trí phụ">${secondaryLocationHTML}</span>`;
                    
                    const isChecked = item.status === 'on' ? 'checked' : '';
                    
                    return `
                        <tr class="fade-in">
                            <td class="account-name clickable" onclick="showAccountNotesModal(${originalIndex})" title="Xem/Sửa ghi chú">${item.account}</td>
                            <td class="diamond-count" onclick="makeEditable(this, ${originalIndex})"><span>${item.current.toLocaleString()}</span></td>
                            <td class="income-expense change-positive">${income > 0 ? `+${income.toLocaleString()}` : '--'}</td>
                            <td class="income-expense change-negative">${expense > 0 ? `-${expense.toLocaleString()}` : '--'}</td>
                            <td class="relative-time" data-timestamp="${lastUpdatedTimestamp || ''}">${formatRelativeTime(lastUpdatedTimestamp)}</td>
                            <td class="location-cell" onclick="showLocationDropdown(event, ${originalIndex})">${locationDisplay}</td>
                            <td>
                                <div class="action-buttons">
                                    <label class="toggle-switch" title="Chuyển trạng thái ON/OFF">
                                        <input type="checkbox" onchange="toggleAccountStatus(${originalIndex}, event)" ${isChecked}>
                                        <span class="slider"></span>
                                    </label>
                                    <button class="btn-small btn-check" onclick="manualUpdateTimestamp(${originalIndex})" title="Check thủ công"><i class="fa-solid fa-check"></i></button>
                                    <button class="btn-small btn-sync" onclick="resetIncomeExpense(${originalIndex})" title="Reset Thu/Chi"><i class="fa-solid fa-sync-alt"></i></button>
                                    <button class="btn-small btn-history" onclick="showHistory(${originalIndex})" title="Xem lịch sử"><i class="fa-solid fa-history"></i></button>
                                    <button class="btn-small btn-edit" onclick="edit(${originalIndex})" title="Chỉnh sửa"><i class="fa-solid fa-pencil"></i></button>
                                    <button class="btn-small btn-delete" onclick="del(${originalIndex})" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                }).join("");
                const total = grouped[server].reduce((sum, item) => sum + item.current, 0);
                serverTables.innerHTML += `
                    <div class="server-section fade-in">
                        <div class="server-header">
                            <span><i class="fa-solid fa-server"></i> Server: ${server} (${grouped[server].length} acc)</span>
                            <div class="server-stats" onclick="showServerStats('${server}')" title="Xem thống kê hàng ngày của server">${total.toLocaleString()} KC</div>
                        </div>
                        <table><thead><tr><th>Account</th><th>Kim cương</th><th>Tổng Thu</th><th>Tổng Chi</th><th>Cập nhật</th><th>Vị trí</th><th>Hành động</th></tr></thead><tbody>${rows}</tbody></table>
                    </div>`;
            });
        }
    } catch (e) {
        console.error("Lỗi nghiêm trọng khi render giao diện:", e);
        document.body.innerHTML = `<div style="text-align: center; padding: 50px; color: red;"><h1>Lỗi nghiêm trọng</h1><p>Đã xảy ra lỗi khi hiển thị dữ liệu. Vui lòng kiểm tra Console (F12) để biết chi tiết. Thử xóa dữ liệu cũ nếu cần thiết.</p></div>`;
    }
}

function addOrUpdate() {
    const account = document.getElementById("account").value.trim();
    const server = document.getElementById("server").value.trim().toUpperCase();
    const currentStr = document.getElementById("current").value;
    const current = currentStr ? parseInt(currentStr) : NaN;
    const editIndex = document.getElementById("editIndex").value;
    if (!account || !server) { showToast("Vui lòng nhập Tên account và Server!", "danger"); return; }
    let isUpdating = false;
    if (editIndex !== "") {
        const originalItem = data[parseInt(editIndex)];
        const isDuplicate = data.some((item, index) => item.account === account && item.server === server && index != parseInt(editIndex));
        if (isDuplicate) { showToast(`Lỗi! Account "${account}" đã tồn tại trên server "${server}".`, "danger"); return; }
        originalItem.account = account; originalItem.server = server;
        if (!isNaN(current)) {
            if (current !== originalItem.current) addHistoryEntry(parseInt(editIndex), current, 'Cập nhật thủ công qua form');
            else manualUpdateTimestamp(parseInt(editIndex));
        }
        isUpdating = true;
    } else {
        if (isNaN(current) || current < 0) { showToast("Kim cương khởi tạo không hợp lệ!", "danger"); return; }
        const isDuplicate = data.some(item => item.account === account && item.server === server);
        if (isDuplicate) { showToast(`Account "${account}" đã tồn tại trên server "${server}".`, "danger"); return; }
        const newItem = { account, server, current: 0, history: [], performanceResetTimestamp: null, location: {primary: '', secondary: ''}, status: 'on', notes: [] };
        data.push(newItem);
        addHistoryEntry(data.length - 1, current, 'Khởi tạo tài khoản');
    }
    save(); render();
    showToast(`Account đã ${isUpdating ? 'cập nhật' : 'thêm mới'}!`, 'success');
    clearForm();
}

function edit(index) {
    const item = data[index];
    document.getElementById("editIndex").value = index;
    document.getElementById("account").value = item.account;
    document.getElementById("server").value = item.server;
    document.getElementById("current").value = "";
    document.getElementById("current").placeholder = `KC hiện tại: ${item.current.toLocaleString()} (để trống nếu không đổi)`;
    document.querySelector('.form-buttons .btn-primary').innerHTML = '<i class="fa-solid fa-save"></i> Cập nhật Account';
    document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
    document.getElementById("account").focus();
}

function del(index) {
    const item = data[index];
    if (confirm(`Bạn có chắc muốn xoá account "${item.account}" (${item.server})?`)) {
        data.splice(index, 1); save(); render();
        showToast(`Đã xóa account "${item.account}"`, 'danger');
        clearForm();
    }
}

function resetAll() {
    if (confirm("BẠN CÓ CHẮC MUỐN XOÁ TOÀN BỘ DỮ LIỆU?\n\nHành động này không thể hoàn tác!")) {
        data = []; save(); render();
        showToast("Đã xóa toàn bộ dữ liệu!", 'danger');
        clearForm();
    }
}

function clearForm() {
    document.getElementById("account").value = "";
    document.getElementById("server").value = "";
    document.getElementById("current").value = "";
    document.getElementById("editIndex").value = "";
    document.getElementById("current").placeholder = "Kim cương khởi tạo";
    document.querySelector('.form-buttons .btn-primary').innerHTML = '<i class="fa-solid fa-save"></i> Lưu / Cập nhật';
    document.getElementById("account").focus();
}

function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filteredData = data.filter(item =>
        item.account.toLowerCase().includes(searchTerm) ||
        item.server.toLowerCase().includes(searchTerm) ||
        (item.location?.primary && item.location.primary.toLowerCase().includes(searchTerm)) ||
        (item.location?.secondary && item.location.secondary.toLowerCase().includes(searchTerm))
    );
    render(filteredData);
}

function makeEditable(tdElement, index) {
    if (tdElement.querySelector('input')) return;
    const originalValue = data[index].current;
    tdElement.innerHTML = `<input type="number" value="${originalValue}" />`;
    const input = tdElement.querySelector('input');
    input.focus(); input.select();
    input.onblur = () => saveDirectEdit(input, index);
    input.onkeydown = (e) => {
        if (e.key === 'Enter') e.target.blur();
        else if (e.key === 'Escape') render();
    };
}

function saveDirectEdit(input, index) {
    if (!document.body.contains(input)) return;
    const newValue = parseInt(input.value);
    const item = data[index];
    const originalValue = item.current;
    if (isNaN(newValue) || newValue < 0) { showToast("Số kim cương không hợp lệ!", "danger"); render(); return; }
    if (newValue === originalValue) { render(); return; }
    const change = newValue - originalValue;
    _noteModalState = { index, newValue };
    document.getElementById('noteModalInfo').innerHTML = `Thay đổi KC từ <b>${originalValue.toLocaleString()}</b> thành <b>${newValue.toLocaleString()}</b> (${change > 0 ? '+' : ''}${change.toLocaleString()})`;
    const noteInput = document.getElementById('noteInput');
    const noteOtherBtn = document.getElementById('noteOtherBtn');
    const noteAltOptions = document.getElementById('noteAltOptions');
    if (change > 0) {
        noteInput.value = "Bán vật phẩm"; noteOtherBtn.style.display = 'none'; noteAltOptions.style.display = 'none';
    } else {
        noteInput.value = "Mua vật phẩm"; noteOtherBtn.style.display = 'inline-flex'; noteAltOptions.style.display = 'none';
    }
    document.getElementById('noteInputGroup').style.display = 'flex';
    document.getElementById('noteModal').classList.add('active');
    noteInput.focus(); noteInput.select();
}

// === KHU VỰC LOGIC VỊ TRÍ ĐÃ ĐƯỢC THAY THẾ HOÀN TOÀN ===

/**
 * Hiển thị dropdown quản lý vị trí "tất cả trong một".
 */
function showLocationDropdown(event, accountIndex) {
    event.stopPropagation();
    const target = event.target;
    const dropdown = document.getElementById('customLocationDropdown');
    
    // Xác định loại vị trí (primary/secondary) dựa trên class của phần tử được click
    let locationType = '';
    if (target.classList.contains('location-primary')) {
        locationType = 'primary';
    } else if (target.classList.contains('location-secondary')) {
        locationType = 'secondary';
    } else {
        // Nếu click vào dấu phân cách hoặc vùng trống, không làm gì cả
        return;
    }

    // Thu thập các vị trí đã có, dựa trên loại vị trí
    const locations = new Set();
    data.forEach(item => {
        const loc = item.location?.[locationType];
        if (loc) locations.add(loc);
    });
    
    // Tạo HTML cho dropdown
    let listItemsHTML = '';
    if (locations.size > 0) {
        listItemsHTML = [...locations].sort().map(loc => `
            <li data-location="${loc}">
                <span class="location-text">${loc}</span>
                <i class="fa-solid fa-times delete-suggestion-btn" data-location-to-delete="${loc}" title="Xóa '${loc}' khỏi tất cả tài khoản"></i>
            </li>
        `).join('');
    } else {
        listItemsHTML = '<li class="empty-list">Không có vị trí nào.</li>';
    }

    dropdown.innerHTML = `
        <div class="location-dropdown-header">
            <input type="text" id="newLocationInput" placeholder="Thêm vị trí mới và Enter..." />
        </div>
        <ul class="location-dropdown-list">
            ${listItemsHTML}
        </ul>
    `;

    // Định vị và hiển thị dropdown
    const cellRect = target.closest('td').getBoundingClientRect();
    dropdown.style.left = `${cellRect.left + window.scrollX}px`;
    dropdown.style.top = `${cellRect.bottom + window.scrollY}px`;
    dropdown.style.minWidth = `${cellRect.width}px`;
    dropdown.classList.add('show');

    // Gán sự kiện sau khi dropdown đã được thêm vào DOM
    const newLocationInput = document.getElementById('newLocationInput');
    newLocationInput.focus();
    newLocationInput.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const newLocationValue = e.target.value.trim();
            if (newLocationValue) {
                addLocation(newLocationValue, locationType, accountIndex);
            }
        }
    };
    
    dropdown.querySelectorAll('.location-dropdown-list li[data-location]').forEach(li => {
        // Sự kiện chọn một vị trí
        li.querySelector('.location-text').onclick = () => {
            data[accountIndex].location[locationType] = li.dataset.location;
            save();
            render();
            hideLocationDropdown();
        };
        // Sự kiện xóa một vị trí
        li.querySelector('.delete-suggestion-btn').onclick = (e) => {
            e.stopPropagation();
            deleteSavedLocation(e.target.dataset.locationToDelete, locationType);
        };
    });
}

/**
 * Thêm một vị trí mới và gán nó cho tài khoản hiện tại.
 */
function addLocation(newLocation, locationType, accountIndex) {
    data[accountIndex].location[locationType] = newLocation;
    save();
    render();
    hideLocationDropdown();
    showToast(`Đã thêm và chọn vị trí mới: "${newLocation}"`, 'success');
}


/**
 * Xóa một vị trí đã lưu khỏi TẤT CẢ các tài khoản.
 */
function deleteSavedLocation(locationToDelete, locationType) {
    if (confirm(`Bạn có chắc muốn XOÁ vị trí "${locationToDelete}" khỏi TẤT CẢ các tài khoản không? Hành động này không thể hoàn tác.`)) {
        let changedCount = 0;
        data.forEach(item => {
            if (item.location && item.location[locationType] === locationToDelete) {
                item.location[locationType] = '';
                changedCount++;
            }
        });

        if (changedCount > 0) {
            save();
            render(); 
            showToast(`Đã xóa vị trí "${locationToDelete}" khỏi ${changedCount} tài khoản.`, 'danger');
        } else {
            showToast(`Không tìm thấy vị trí "${locationToDelete}" để xóa.`, 'info');
        }
        hideLocationDropdown();
    }
}

function hideLocationDropdown() {
    document.getElementById('customLocationDropdown').classList.remove('show');
}

// === KẾT THÚC KHU VỰC LOGIC VỊ TRÍ ===


function showAltNoteOptions() {
    document.getElementById('noteInputGroup').style.display = 'none';
    document.getElementById('noteAltOptions').style.display = 'flex';
}

function setNoteAndConfirm(note) {
    document.getElementById('noteInput').value = note;
    confirmNoteChange();
}

function confirmNoteChange() {
    const { index, newValue } = _noteModalState;
    if (index === undefined) return;
    const note = document.getElementById('noteInput').value.trim() || 'Không có ghi chú';
    addHistoryEntry(index, newValue, note);
    save(); render();
    showToast(`Đã cập nhật KC cho ${data[index].account}!`, "success");
    closeNoteModal();
}

function resetIncomeExpense(index) {
    const item = data[index];
    if (confirm(`Bạn có chắc muốn reset bộ đếm Thu/Chi cho account "${item.account}"?\n\nLịch sử giao dịch vẫn được giữ lại.`)) {
        item.performanceResetTimestamp = new Date().toISOString();
        save(); render();
        showToast(`Đã reset Thu/Chi cho ${item.account}`, 'info');
    }
}

function addHistoryEntry(index, newBalance, note) {
    const item = data[index]; if (!item) return;
    const oldBalance = item.current || 0;
    const change = newBalance - oldBalance;
    let type = 'set';
    if (item.history && item.history.length > 0) type = change > 0 ? 'add' : 'subtract';
    item.history.unshift({ timestamp: new Date().toISOString(), type: type, amount: Math.abs(change), note: note, oldBalance: oldBalance, newBalance: newBalance });
    if (item.history.length > 200) item.history.pop();
    item.current = newBalance;
}

function showHistory(index) {
    const item = data[index];
    const modal = document.getElementById('historyModal');
    document.getElementById('historyModalTitle').textContent = `Nhật ký: ${item.account} (${item.server})`;
    const exportBtn = document.getElementById('exportHistoryBtn');
    exportBtn.onclick = () => exportHistoryForAccount(index);
    const lifetime = calculateIncomeExpense(item.history, null);
    document.getElementById('lifetimeIncome').textContent = `+${lifetime.income.toLocaleString()}`;
    document.getElementById('lifetimeExpense').textContent = `-${lifetime.expense.toLocaleString()}`;
    const tableBody = document.getElementById('historyTableBody'); tableBody.innerHTML = '';
    if (!item.history || item.history.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Chưa có lịch sử giao dịch.</td></tr>'; } 
    else {
        item.history.forEach((entry, historyIndex) => {
            const change = entry.newBalance - entry.oldBalance;
            let changeHTML;
            if (entry.type === 'check') changeHTML = `<span>--</span>`;
            else if (entry.type === 'set' && entry.oldBalance === 0) changeHTML = `<span class="change-positive">+${entry.newBalance.toLocaleString()}</span>`;
            else changeHTML = (change > 0) ? `<span class="change-positive">+${change.toLocaleString()}</span>` : `<span class="change-negative">${change.toLocaleString()}</span>`;
            const rowClass = entry.type === 'check' ? 'type-check' : '';
            tableBody.innerHTML += `<tr class="${rowClass}">
                <td>${new Date(entry.timestamp).toLocaleString('vi-VN')}</td>
                <td>${changeHTML}</td>
                <td class="note-col editable" onclick="makeHistoryNoteEditable(this, ${index}, ${historyIndex})">${entry.note}</td>
                <td>${entry.newBalance.toLocaleString()}</td>
            </tr>`;
        });
    }
    modal.classList.add('active');
}

function closeHistoryModal() { document.getElementById('historyModal').classList.remove('active'); }
function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
    _noteModalState = {};
    render();
}
function closeServerStatsModal() { document.getElementById('serverStatsModal').classList.remove('active'); }
function closeAccountNotesModal() { document.getElementById('accountNotesModal').classList.remove('active'); _accountNotesModalState = {}; }

function makeHistoryNoteEditable(tdElement, accountIndex, historyIndex) {
    if (tdElement.querySelector('input')) return;
    const originalValue = data[accountIndex].history[historyIndex].note;
    tdElement.innerHTML = `<input type="text" value="${originalValue}" />`;
    const input = tdElement.querySelector('input');
    input.focus();
    input.select();
    input.onclick = (e) => e.stopPropagation();
    input.onblur = () => saveHistoryNoteEdit(input, accountIndex, historyIndex);
    input.onkeydown = (e) => {
        if (e.key === 'Enter') e.target.blur();
        else if (e.key === 'Escape') {
            tdElement.innerHTML = originalValue;
        }
    };
}

function saveHistoryNoteEdit(input, accountIndex, historyIndex) {
    if (!document.body.contains(input)) return;
    const newValue = input.value.trim();
    data[accountIndex].history[historyIndex].note = newValue;
    save();
    input.parentElement.innerHTML = newValue;
    showToast('Đã cập nhật ghi chú giao dịch!', 'success');
}

function showAccountNotesModal(accountIndex) {
    _accountNotesModalState = { index: accountIndex };
    const item = data[accountIndex];
    const modal = document.getElementById('accountNotesModal');
    document.getElementById('accountNotesModalTitle').textContent = `Ghi chú cho: ${item.account} (${item.server})`;
    document.getElementById('newNoteInput').value = '';
    renderAccountNotes();
    modal.classList.add('active');
}

function renderAccountNotes() {
    const { index } = _accountNotesModalState;
    if (index === undefined) return;
    const item = data[index];
    if (!item) return; 
    const listElement = document.getElementById('notesList');
    listElement.innerHTML = '';
    
    if (!item.notes || item.notes.length === 0) {
        listElement.innerHTML = '<li style="justify-content: center; color: #888;">Chưa có ghi chú nào.</li>';
        return;
    }

    item.notes.forEach((note, noteIndex) => {
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="note-content">
                <span class="note-text" onclick="makeAccountNoteEditable(this, ${noteIndex})">${note.text.replace(/\n/g, '<br>')}</span>
                <span class="note-timestamp">${new Date(note.timestamp).toLocaleString('vi-VN')}</span>
            </div>
            <div class="note-actions">
                <button class="btn-small btn-delete" onclick="deleteAccountNote(event, ${noteIndex})" title="Xóa"><i class="fa-solid fa-trash"></i></button>
            </div>
        `;
        listElement.appendChild(li);
    });
}

function addNewAccountNote() {
    const { index } = _accountNotesModalState;
    const input = document.getElementById('newNoteInput');
    const text = input.value.trim();
    if (!text) {
        showToast('Vui lòng nhập nội dung ghi chú!', 'danger');
        return;
    }
    data[index].notes.unshift({ text: text, timestamp: new Date().toISOString() });
    save();
    input.value = '';
    renderAccountNotes();
}

function deleteAccountNote(event, noteIndex) {
    event.stopPropagation();
    if (confirm('Bạn có chắc muốn xóa ghi chú này không?')) {
        const { index } = _accountNotesModalState;
        data[index].notes.splice(noteIndex, 1);
        save();
        renderAccountNotes();
        showToast('Đã xóa ghi chú!', 'danger');
    }
}

function makeAccountNoteEditable(spanElement, noteIndex) {
    const li = spanElement.closest('li');
    if (li.querySelector('textarea')) return;
    
    const { index: accountIndex } = _accountNotesModalState;
    const originalText = data[accountIndex].notes[noteIndex].text;
    const noteContentDiv = spanElement.parentElement;
    
    const textarea = document.createElement('textarea');
    textarea.value = originalText;
    textarea.rows = Math.max(3, (originalText.match(/\n/g) || []).length + 1);

    spanElement.style.display = 'none';
    noteContentDiv.prepend(textarea);
    textarea.focus();
    
    const saveChanges = () => {
        const newText = textarea.value;
        if (newText.trim() !== originalText.trim()) {
            data[accountIndex].notes[noteIndex].text = newText;
            data[accountIndex].notes[noteIndex].timestamp = new Date().toISOString();
            save();
            showToast('Đã cập nhật ghi chú!', 'success');
        }
        renderAccountNotes();
    };

    textarea.addEventListener('blur', saveChanges);
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            textarea.blur();
        } else if (e.key === 'Escape') {
            textarea.removeEventListener('blur', saveChanges);
            renderAccountNotes();
        }
    });
}

function showServerStats(serverName) {
    const modal = document.getElementById('serverStatsModal');
    const modalTitle = document.getElementById('serverStatsModalTitle');
    const modalBody = document.getElementById('serverStatsBody');
    modalTitle.textContent = `Thống kê hàng ngày: Server ${serverName}`;
    modalBody.innerHTML = 'Đang tính toán...';
    const accountsOnServer = data.filter(item => item.server === serverName);
    const dailyStats = {};
    accountsOnServer.forEach(account => {
        if (account.history) {
            account.history.forEach(entry => {
                if (entry.oldBalance === entry.newBalance || entry.type === 'check') return;
                const dateKey = new Date(entry.timestamp).toISOString().slice(0, 10);
                if (!dailyStats[dateKey]) {
                    dailyStats[dateKey] = { income: 0, expense: 0, balance: 0 };
                }
                const change = entry.newBalance - entry.oldBalance;
                dailyStats[dateKey].balance += change;
                if (change > 0) {
                    dailyStats[dateKey].income += change;
                } else {
                    dailyStats[dateKey].expense += Math.abs(change);
                }
            });
        }
    });
    const sortedDates = Object.keys(dailyStats).sort().reverse();
    if (sortedDates.length === 0) {
        modalBody.innerHTML = '<p style="text-align: center; color: #666;">Không có dữ liệu giao dịch cho server này.</p>';
    } else {
        let tableHTML = '<table class="history-table"><thead><tr><th>Ngày</th><th>Tổng Thu</th><th>Tổng Chi</th><th>Số dư cuối</th></tr></thead><tbody>';
        sortedDates.forEach(dateKey => {
            const stats = dailyStats[dateKey];
            const [year, month, day] = dateKey.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const balance = stats.balance;
            let balanceHTML;
            if (balance > 0) {
                balanceHTML = `<td class="change-positive">+${balance.toLocaleString()}</td>`;
            } else if (balance < 0) {
                balanceHTML = `<td class="change-negative">${balance.toLocaleString()}</td>`;
            } else {
                balanceHTML = `<td>0</td>`;
            }
            tableHTML += `<tr><td>${formattedDate}</td><td class="change-positive">+${stats.income.toLocaleString()}</td><td class="change-negative">-${stats.expense.toLocaleString()}</td>${balanceHTML}</tr>`;
        });
        tableHTML += '</tbody></table>';
        modalBody.innerHTML = tableHTML;
    }
    modal.classList.add('active');
}

function exportHistoryForAccount(index) {
    const item = data[index];
    if (!item || !item.history || item.history.length === 0) { showToast("Không có lịch sử để xuất!", "info"); return; }
    const dataStr = JSON.stringify(item.history, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `history_${item.account}_${item.server}_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function triggerImport() { document.getElementById('importFile').click(); }

function handleFileImport(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!Array.isArray(importedData)) {
                throw new Error("File không đúng định dạng.");
            }
            if (confirm("Nhập dữ liệu sẽ GHI ĐÈ toàn bộ dữ liệu hiện tại. Bạn có chắc chắn?")) {
                const { migratedData } = migrateData(importedData);
                data = migratedData;
                save();
                render();
                showToast("Nhập dữ liệu thành công!", "success");
            }
        } catch (error) { showToast("Lỗi khi đọc file: " + error.message, "danger");
        } finally { event.target.value = null; }
    };
    reader.readAsText(file);
}

document.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
        const noteModalActive = document.getElementById('noteModal').classList.contains('active');
        const formInputActive = document.activeElement.closest('.form-section');
        const newAccountNoteActive = document.activeElement.id === 'newNoteInput';
        if (noteModalActive) { e.preventDefault(); confirmNoteChange(); } 
        else if (formInputActive) { e.preventDefault(); addOrUpdate(); }
        else if (newAccountNoteActive && !e.shiftKey) { e.preventDefault(); addNewAccountNote(); }
    } else if (e.key === 'Escape') {
        if (document.getElementById('noteModal').classList.contains('active')) closeNoteModal();
        if (document.getElementById('historyModal').classList.contains('active')) closeHistoryModal();
        if (document.getElementById('serverStatsModal').classList.contains('active')) closeServerStatsModal();
        if (document.getElementById('accountNotesModal').classList.contains('active')) closeAccountNotesModal();
        if (document.getElementById('customLocationDropdown').classList.contains('show')) hideLocationDropdown();
    }
});

window.onclick = function (event) {
    const dropdown = document.getElementById('customLocationDropdown');
    // Đóng dropdown nếu click ra ngoài dropdown VÀ không phải là click vào một ô vị trí
    if (dropdown.classList.contains('show') && !dropdown.contains(event.target) && !event.target.closest('.location-cell')) {
        hideLocationDropdown();
    }

    const historyModal = document.getElementById('historyModal');
    const noteModal = document.getElementById('noteModal');
    const serverStatsModal = document.getElementById('serverStatsModal');
    const accountNotesModal = document.getElementById('accountNotesModal');
    if (event.target == historyModal) closeHistoryModal();
    if (event.target == noteModal) closeNoteModal();
    if (event.target == serverStatsModal) closeServerStatsModal();
    if (event.target == accountNotesModal) closeAccountNotesModal();
}

function updateRelativeTimes() {
    document.querySelectorAll('.relative-time').forEach(el => {
        const timestamp = el.dataset.timestamp;
        if (timestamp) el.textContent = formatRelativeTime(timestamp);
    });
}

function initializeApp() {
    let loadedData = [];
    try {
        const rawData = localStorage.getItem("kimcuong_data_v3");
        if (rawData) {
            loadedData = JSON.parse(rawData);
        }
    } catch(e) {
        console.error("Lỗi khi parse dữ liệu từ localStorage:", e);
        loadedData = [];
    }
    
    const { migratedData, needsSave } = migrateData(loadedData);
    data = migratedData;
    if (needsSave) {
        save();
    }
    
    render();
    clearForm();
    setInterval(updateRelativeTimes, 30000);
}

initializeApp();

</script>

</body>
</html>
