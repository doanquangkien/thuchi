<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thu Chi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        form {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-row>div {
            flex: 1;
            min-width: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #3e8e41;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }

        th {
            background-color: #f2f2f2;
            font-weight: 500;
        }

        .actions {
            text-align: center;
        }

        .expense-actions button {
            background-color: #e74c3c;
            color: white;
        }

        .expense-actions button:hover {
            background-color: #c0392b;
        }

        .total {
            font-weight: bold;
            text-align: right;
        }

        .total p {
            margin: 5px 0;
        }

        #monthlyStats,
        #yearlyStats {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }

        #monthlyStats h2,
        #yearlyStats h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        #monthlyStats p,
        #yearlyStats p {
            margin: 5px 0;
        }


        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .form-row {
                flex-direction: column;
            }

            .form-row>div {
                flex: auto;
            }

            input[type="date"],
            input[type="number"],
            select,
            textarea {
                width: 100%;
            }
        }

        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #notification.show {
            opacity: 1;
        }

        #filterOptions {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #filterOptions label {
            margin-right: 10px;
        }

        #filterOptions select,
        #filterOptions input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Style for current date display */
        #currentDateDisplay {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Quản lý Thu Chi Cá Nhân</h1>

        <div id="currentDateDisplay">
            <!-- Current date will be displayed here -->
        </div>

        <form id="entryForm">
            <div class="form-row">
                <div>
                    <label for="date">Ngày:</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div>
                    <label for="type">Loại:</label>
                    <select id="type" name="type" required>
                        <option value="chi">Chi tiêu</option>
                        <option value="thu">Thu nhập</option>
                    </select>
                </div>
                <div>
                    <label for="category">Danh mục:</label>
                    <select id="category" name="category" required>
                        <option value="">Chọn danh mục</option>
                        <option value="Ăn uống">Ăn uống</option>
                        <option value="Đi lại">Đi lại</option>
                        <option value="Mua sắm">Mua sắm</option>
                        <option value="Sức khoẻ">Sức khoẻ</option>
                        <option value="Giải trí">Giải trí</option>
                        <option value="Lương">Lương</option>
                        <option value="Đầu tư">Đầu tư</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
            </div>
            <label for="amount">Số tiền:</label>
            <input type="number" id="amount" name="amount" required>

            <label for="note">Ghi chú:</label>
            <textarea id="note" name="note" rows="3"></textarea>

            <button type="submit">Thêm</button>
        </form>

        <div id="filterOptions">
            <label for="filterCategory">Lọc theo danh mục:</label>
            <select id="filterCategory">
                <option value="">Tất cả</option>
                <option value="Ăn uống">Ăn uống</option>
                <option value="Đi lại">Đi lại</option>
                <option value="Mua sắm">Mua sắm</option>
                <option value="Sức khoẻ">Sức khoẻ</option>
                <option value="Giải trí">Giải trí</option>
                <option value="Lương">Lương</option>
                <option value="Đầu tư">Đầu tư</option>
                <option value="Khác">Khác</option>
            </select>

            <label for="filterType">Lọc theo loại:</label>
            <select id="filterType">
                <option value="">Tất cả</option>
                <option value="chi">Chi tiêu</option>
                <option value="thu">Thu nhập</option>
            </select>

            <label for="filterDate">Lọc theo ngày:</label>
            <input type="date" id="filterDate">

            <button id="filterButton">Lọc</button>
            <button id="resetFilterButton">Bỏ lọc</button>
        </div>


        <table id="entryTable">
            <thead>
                <tr>
                    <th>Ngày</th>
                    <th>Loại</th>
                    <th>Danh mục</th>
                    <th>Số tiền</th>
                    <th>Ghi chú</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dữ liệu sẽ được thêm vào đây bởi JavaScript -->
            </tbody>
        </table>

        <div class="total">
            <p>Tổng chi tiêu: <span id="totalExpenses">0</span></p>
            <p>Tổng thu nhập: <span id="totalIncome">0</span></p>
        </div>

        <div id="monthlyStats">
            <h2>Thống kê tháng</h2>
            <label for="monthSelect">Chọn tháng:</label>
            <input type="month" id="monthSelect">
            <p>Tổng chi tiêu tháng: <span id="monthlyExpenses">0</span></p>
            <p>Tổng thu nhập tháng: <span id="monthlyIncome">0</span></p>
        </div>

        <div id="yearlyStats">
            <h2>Thống kê năm</h2>
            <label for="yearSelect">Chọn năm:</label>
            <input type="number" id="yearSelect" min="2000" max="2100" value="2024">
            <p>Tổng chi tiêu năm: <span id="yearlyExpenses">0</span></p>
            <p>Tổng thu nhập năm: <span id="yearlyIncome">0</span></p>
        </div>

        <button id="exportCsvButton">Xuất CSV</button>

        <div id="notification"></div>
    </div>

    <script>
        const entryForm = document.getElementById('entryForm');
        const entryTable = document.getElementById('entryTable').getElementsByTagName('tbody')[0];
        const totalExpensesElement = document.getElementById('totalExpenses');
        const totalIncomeElement = document.getElementById('totalIncome');
        const filterCategorySelect = document.getElementById('filterCategory');
        const filterTypeSelect = document.getElementById('filterType');
        const filterDateInput = document.getElementById('filterDate');
        const filterButton = document.getElementById('filterButton');
        const resetFilterButton = document.getElementById('resetFilterButton');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const monthSelect = document.getElementById('monthSelect');
        const monthlyExpensesElement = document.getElementById('monthlyExpenses');
        const monthlyIncomeElement = document.getElementById('monthlyIncome');
        const yearSelect = document.getElementById('yearSelect');
        const yearlyExpensesElement = document.getElementById('yearlyExpenses');
        const yearlyIncomeElement = document.getElementById('yearlyIncome');
        const notificationElement = document.getElementById('notification');
        const currentDateDisplay = document.getElementById('currentDateDisplay');


        let entries = JSON.parse(localStorage.getItem('entries')) || [];
        let editingIndex = -1;
        let filteredEntries = null; // Track if a filter is active

        // Function to get today's date in YYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to display the current date
        function displayCurrentDate() {
            const today = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            const formattedDate = today.toLocaleDateString('vi-VN', options);
            currentDateDisplay.textContent = ` ${formattedDate}`;

            // Set default values for month and year selects
            const currentYear = today.getFullYear();
            const currentMonth = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            monthSelect.value = `${currentYear}-${currentMonth}`;
            yearSelect.value = currentYear;
        }

        // Function to show notification
        function showNotification(message, duration = 3000) {
            notificationElement.textContent = message;
            notificationElement.classList.add('show');

            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, duration);
        }

        // Function to format number with dots
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Function to render the table
        function renderTable(data) {
            entryTable.innerHTML = '';

            let totalExpenses = 0;
            let totalIncome = 0;

            if (!data) {
                data = getTodayEntries(); // Default to today's entries if no data is passed
            }

            data.forEach((entry, index) => {
                let row = entryTable.insertRow();

                let dateCell = row.insertCell(0);
                let typeCell = row.insertCell(1);
                let categoryCell = row.insertCell(2);
                let amountCell = row.insertCell(3);
                let noteCell = row.insertCell(4);
                let actionsCell = row.insertCell(5);

                dateCell.innerHTML = entry.date;
                typeCell.innerHTML = entry.type === 'chi' ? 'Chi tiêu' : 'Thu nhập';
                categoryCell.innerHTML = entry.category;
                amountCell.innerHTML = formatNumber(parseFloat(entry.amount));
                noteCell.innerHTML = entry.note;

                actionsCell.classList.add('actions');
                let actionsHTML = `
                    <button onclick="editEntry('${entry.date}', ${index})">Sửa</button>
                    <button onclick="deleteEntry('${entry.date}', ${index})">Xóa</button>
                `;
                if (entry.type === 'chi') {
                    actionsCell.classList.add('expense-actions');
                }
                actionsCell.innerHTML = actionsHTML;
                if (entry.type === 'chi') {
                    actionsCell.classList.add('expense-actions');
                }

                if (entry.type === 'chi') {
                    totalExpenses += parseFloat(entry.amount);
                } else {
                    totalIncome += parseFloat(entry.amount);
                }
            });

            totalExpensesElement.textContent = formatNumber(totalExpenses);
            totalIncomeElement.textContent = formatNumber(totalIncome);

            updateMonthlyStats();
            updateYearlyStats();
        }

        // Function to save entries to local storage
        function saveEntries() {
            localStorage.setItem('entries', JSON.stringify(entries));
        }

        // Function to add entry
        function addEntry(event) {
            event.preventDefault();

            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = document.getElementById('amount').value;
            const note = document.getElementById('note').value;

            if (editingIndex === -1) {
                entries.push({
                    date,
                    type,
                    category,
                    amount,
                    note
                });
                showNotification('Thêm mục thành công!');
            } else {
                entries[editingIndex] = {
                    date,
                    type,
                    category,
                    amount,
                    note
                };
                editingIndex = -1;
                entryForm.querySelector('button[type="submit"]').textContent = "Thêm";
                showNotification('Cập nhật mục thành công!');
            }

            saveEntries();
            renderTable(filteredEntries || getTodayEntries()); // Use filteredEntries if available
            entryForm.reset();
        }

        // Function to delete entry
        function deleteEntry(date, index) {
            if (confirm('Bạn có chắc chắn muốn xóa mục này?')) {
               // Find the entry in the entries array based on the date and index
                const entryToDelete = (filteredEntries || getTodayEntries())[index];

                if (entryToDelete) {
                    const indexInEntries = entries.findIndex(entry =>
                        entry.date === entryToDelete.date &&
                        entry.type === entryToDelete.type &&
                        entry.category === entryToDelete.category &&
                        entry.amount === entryToDelete.amount &&
                        entry.note === entryToDelete.note
                    );

                    if (indexInEntries !== -1) {
                        entries.splice(indexInEntries, 1);
                        saveEntries();
                        showNotification('Xóa mục thành công!');
                    } else {
                        console.error('Entry not found in entries array');
                    }
                } else {
                    console.error('Entry not found in filtered entries array');
                }
                saveEntries();
                renderTable(filteredEntries || getTodayEntries());
                showNotification('Xóa mục thành công!');
            }
        }

         // Function to edit entry
        function editEntry(date, index) {
            let entryToEdit = (filteredEntries || getTodayEntries())[index];

            if (!entryToEdit) {
                console.error("Entry not found for editing.");
                return;
            }

            // Find the index of the entry in the original 'entries' array
            editingIndex = entries.findIndex(entry =>
                entry.date === entryToEdit.date &&
                entry.type === entryToEdit.type &&
                entry.category === entryToEdit.category &&
                entry.amount === entryToEdit.amount &&
                entry.note === entryToEdit.note
            );

            if (editingIndex === -1) {
                console.error("Entry not found in main entries array.");
                return;
            }

            // Populate the form with the entry data
            document.getElementById('date').value = entryToEdit.date;
            document.getElementById('type').value = entryToEdit.type;
            document.getElementById('category').value = entryToEdit.category;
            document.getElementById('amount').value = entryToEdit.amount;
            document.getElementById('note').value = entryToEdit.note;

            entryForm.querySelector('button[type="submit"]').textContent = "Cập nhật";
        }


        // Function to filter entries
        function filterEntries() {
            const category = filterCategorySelect.value;
            const type = filterTypeSelect.value;
            const date = filterDateInput.value;

            filteredEntries = entries.filter(entry => {
                if (category && entry.category !== category) {
                    return false;
                }
                if (type && entry.type !== type) {
                    return false;
                }
                if (date && entry.date !== date) {
                    return false;
                }
                return true;
            });

            renderTable(filteredEntries);
        }

        // Function to reset filter
        function resetFilter() {
            filterCategorySelect.value = '';
            filterTypeSelect.value = '';
            filterDateInput.value = '';
            filteredEntries = null; // Clear the filteredEntries variable
            renderTable(getTodayEntries()); // Re-render with only today's entries
        }

        // Function to export to CSV
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Ngày,Loại,Danh mục,Số tiền,Ghi chú\r\n";

            entries.forEach(entry => {
                csvContent += `${entry.date},${entry.type === 'chi' ? 'Chi tiêu' : 'Thu nhập'},${entry.category},${entry.amount},"${entry.note.replace(/"/g, '""')}"\r\n`;
            });

            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "entries.csv");
            document.body.appendChild(link);

            link.click();
            showNotification('Xuất CSV thành công!');
        }

        // Function to update monthly stats
        function updateMonthlyStats() {
            const selectedMonth = monthSelect.value; // Format: YYYY-MM
            let monthlyExpenses = 0;
            let monthlyIncome = 0;

            entries.forEach(entry => {
                const entryMonth = entry.date.substring(0, 7); // Extract YYYY-MM from the entry date
                if (entryMonth === selectedMonth) {
                    if (entry.type === 'chi') {
                        monthlyExpenses += parseFloat(entry.amount);
                    } else {
                        monthlyIncome += parseFloat(entry.amount);
                    }
                }
            });

            monthlyExpensesElement.textContent = formatNumber(monthlyExpenses);
            monthlyIncomeElement.textContent = formatNumber(monthlyIncome);
        }

        // Function to update yearly stats
        function updateYearlyStats() {
            const selectedYear = yearSelect.value;
            let yearlyExpenses = 0;
            let yearlyIncome = 0;

            entries.forEach(entry => {
                const entryYear = entry.date.substring(0, 4); // Extract YYYY from the entry date
                if (entryYear === selectedYear) {
                    if (entry.type === 'chi') {
                        yearlyExpenses += parseFloat(entry.amount);
                    } else {
                        yearlyIncome += parseFloat(entry.amount);
                    }
                }
            });

            yearlyExpensesElement.textContent = formatNumber(yearlyExpenses);
            yearlyIncomeElement.textContent = formatNumber(yearlyIncome);
        }

        // Function to get entries for today's date
        function getTodayEntries() {
            const todayDate = getTodayDate();
            return entries.filter(entry => entry.date === todayDate);
        }

        // Function to check if the last display date is today, and filter if not
        function filterOldEntriesIfNeeded() {
            const lastDisplayDate = localStorage.getItem('lastDisplayDate');
            const todayDate = getTodayDate();

            if (lastDisplayDate !== todayDate) {
                entries = entries.filter(entry => entry.date === todayDate);
                saveEntries(); // Save the filtered entries
                localStorage.setItem('lastDisplayDate', todayDate);
            }
        }


        // Event listeners
        entryForm.addEventListener('submit', addEntry);
        filterButton.addEventListener('click', filterEntries);
        resetFilterButton.addEventListener('click', resetFilter);
        exportCsvButton.addEventListener('click', exportToCSV);
        monthSelect.addEventListener('change', updateMonthlyStats);
        yearSelect.addEventListener('change', updateYearlyStats);

        // Initial setup
        document.getElementById('date').value = getTodayDate(); // Set default date in the form
        displayCurrentDate(); // Display current date
        filterOldEntriesIfNeeded(); // Filter data if needed

        updateMonthlyStats();
        updateYearlyStats();


        // Initial render
        renderTable(getTodayEntries());
    </script>

</body>

</html>
