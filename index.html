<!DOCTYPE html>
<html lang="vi">
<head>
 <meta charset="UTF-8">
 <title>Qu·∫£n l√Ω kim c∆∞∆°ng v3.0 (Google Sheets)</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
 <!-- Th√™m Font Awesome ƒë·ªÉ c√≥ icons -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <style>
 :root {
 --primary-color: #4f46e5;
 --danger-color: #ff6b6b;
 --success-color: #10b981;
 --warning-color: #f59e0b;
 --background-dark1: #1a1a2e;
 --background-dark2: #16213e;
 --background-dark3: #0f3460;
 --white: #ffffff;
 --light-gray: #f8f9fa;
 --medium-gray: #e0e6ed;
 --dark-gray: #374151;
 --text-color: #333;
 }
 
 * {
 box-sizing: border-box;
 }
 
 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
 margin: 0;
 padding: 0;
 background: linear-gradient(135deg, var(--background-dark1) 0%, var(--background-dark2) 50%, var(--background-dark3) 100%);
 min-height: 100vh;
 color: var(--text-color);
 }

 .container {
 max-width: 1200px;
 margin: 0 auto;
 padding: 20px;
 }

 .header {
 text-align: center;
 margin-bottom: 30px;
 color: var(--white);
 }

 .header h2 {
 font-size: 2.5rem;
 margin: 0;
 text-shadow: 0 2px 4px rgba(0,0,0,0.3);
 font-weight: 700;
 }

 .header p {
 margin: 10px 0 0 0;
 opacity: 0.9;
 font-size: 1.1rem;
 }

 .status-indicator {
 display: inline-flex;
 align-items: center;
 gap: 8px;
 padding: 8px 16px;
 margin-top: 10px;
 border-radius: 20px;
 font-size: 0.9rem;
 font-weight: 600;
 }

 .status-online {
 background: rgba(16, 185, 129, 0.2);
 color: var(--success-color);
 border: 1px solid var(--success-color);
 }

 .status-offline {
 background: rgba(255, 107, 107, 0.2);
 color: var(--danger-color);
 border: 1px solid var(--danger-color);
 }

 .status-loading {
 background: rgba(245, 158, 11, 0.2);
 color: var(--warning-color);
 border: 1px solid var(--warning-color);
 }

 .card {
 background: var(--white);
 border-radius: 20px;
 padding: 30px;
 margin-bottom: 30px;
 box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray);
 transition: transform 0.2s ease, box-shadow 0.2s ease;
 }

 .card:hover {
 transform: translateY(-2px);
 box-shadow: 0 12px 40px rgba(0,0,0,0.15);
 }

 .input-group {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
 gap: 20px;
 margin-bottom: 25px;
 }

 .form-section input[type="text"],
 .form-section input[type="number"],
 .controls-section input[type="search"] {
 width: 100%;
 padding: 16px 20px;
 font-size: 16px;
 border: 2px solid #e1e5e9;
 border-radius: 12px;
 background: var(--white);
 transition: all 0.3s ease;
 outline: none;
 }

 .form-section input:focus,
 .controls-section input:focus {
 border-color: var(--primary-color);
 box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
 transform: translateY(-1px);
 }

 .form-section input::placeholder,
 .controls-section input::placeholder {
 color: #a0a8b0;
 }

 .form-buttons, .controls-buttons {
 display: flex;
 gap: 15px;
 flex-wrap: wrap;
 }

 .btn {
 flex: 1;
 min-width: 160px;
 padding: 16px 24px;
 font-size: 16px;
 font-weight: 600;
 border: none;
 border-radius: 12px;
 cursor: pointer;
 transition: all 0.3s ease;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 gap: 10px;
 position: relative;
 overflow: hidden;
 }

 .btn:disabled {
 opacity: 0.6;
 cursor: not-allowed;
 }

 .btn::before {
 content: '';
 position: absolute;
 top: 0;
 left: -100%;
 width: 100%;
 height: 100%;
 background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
 transition: left 0.5s;
 }

 .btn:hover:not(:disabled)::before {
 left: 100%;
 }

 .btn-primary {
 background: linear-gradient(135deg, #4f46e5, #7c3aed);
 color: white;
 box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
 }

 .btn-primary:hover:not(:disabled) {
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
 }

 .btn-danger {
 background: linear-gradient(135deg, var(--danger-color), #ee5a52);
 color: white;
 box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
 }

 .btn-danger:hover:not(:disabled) {
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
 }

 .btn-secondary {
 background: linear-gradient(135deg, #64748b, #475569);
 color: white;
 box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
 }

 .btn-secondary:hover:not(:disabled) {
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
 }

 .server-section {
 background: var(--white);
 border-radius: 20px;
 margin-bottom: 25px;
 overflow: hidden;
 box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray);
 transition: transform 0.2s ease;
 }

 .server-section:hover {
 transform: translateY(-2px);
 }

 .server-header {
 background: linear-gradient(135deg, #1f2937, var(--dark-gray));
 color: white;
 padding: 20px 30px;
 font-size: 1.3rem;
 font-weight: 600;
 display: flex;
 align-items: center;
 justify-content: space-between;
 gap: 10px;
 }
 
 .server-stats {
 background: var(--primary-color);
 padding: 8px 16px;
 border-radius: 20px;
 font-size: 1.1rem;
 font-weight: 700;
 text-shadow: 0 1px 2px rgba(0,0,0,0.2);
 }

 table {
 width: 100%;
 border-collapse: collapse;
 font-size: 15px;
 background: var(--white);
 }

 th, td {
 padding: 16px 20px;
 text-align: center;
 border-bottom: 1px solid #f0f0f0;
 }

 th {
 background: var(--light-gray);
 color: #555;
 font-weight: 600;
 font-size: 14px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 tbody tr {
 transition: background-color 0.2s ease;
 }

 tbody tr:hover {
 background: var(--light-gray);
 }

 .account-name {
 font-weight: 600;
 color: var(--text-color);
 }

 .diamond-count {
 font-weight: 700;
 color: var(--primary-color);
 font-size: 1.1rem;
 cursor: pointer;
 border-radius: 8px;
 transition: background-color 0.2s ease;
 }
 .diamond-count:hover {
    background-color: #f0f8ff;
 }
 .diamond-count input {
    width: 100px;
    text-align: center;
    border: 1px solid var(--primary-color);
    border-radius: 5px;
    padding: 5px;
    font-size: 1rem;
    font-weight: 700;
 }

 .action-buttons {
 display: flex;
 gap: 8px;
 justify-content: center;
 }

 .btn-small {
 padding: 8px 12px;
 font-size: 14px;
 border: none;
 border-radius: 8px;
 cursor: pointer;
 transition: all 0.2s ease;
 font-weight: 500;
 }

 .btn-edit {
 background: var(--warning-color);
 color: white;
 }

 .btn-edit:hover {
 background: #d97706;
 transform: scale(1.05);
 }

 .btn-delete {
 background: var(--danger-color);
 color: white;
 }

 .btn-delete:hover {
 background: #ee5a52;
 transform: scale(1.05);
 }

 .empty-state {
 text-align: center;
 padding: 60px 20px;
 background: var(--white);
 border-radius: 20px;
 color: #666;
 }

 .empty-state-icon {
 font-size: 4rem;
 margin-bottom: 20px;
 opacity: 0.5;
 color: var(--primary-color);
 }

 .loading-spinner {
 display: inline-block;
 width: 20px;
 height: 20px;
 border: 3px solid rgba(255,255,255,.3);
 border-radius: 50%;
 border-top-color: #fff;
 animation: spin 1s ease-in-out infinite;
 }

 @keyframes spin {
 to { transform: rotate(360deg); }
 }

 /* --- CSS CHO TOAST MESSAGE --- */
 #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
 }
 .toast {
    background-color: var(--dark-gray);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
 }
 .toast.show {
    opacity: 1;
    transform: translateX(0);
 }
 .toast.toast-success { background-color: var(--success-color); }
 .toast.toast-danger { background-color: var(--danger-color); }

 @media (max-width: 768px) {
 .container { padding: 15px; }
 .header h2 { font-size: 2rem; }
 .card { padding: 20px; border-radius: 16px; }
 .input-group, .controls-section { grid-template-columns: 1fr; gap: 15px; }
 .form-buttons, .controls-buttons { flex-direction: column; }
 .btn { min-width: auto; }
 .server-header { padding: 15px 20px; font-size: 1.1rem; flex-direction: column; align-items: stretch; gap: 8px; }
 .server-stats { text-align: center; }
 th, td { padding: 12px 8px; font-size: 14px; }
 .action-buttons { flex-direction: column; gap: 4px; }
 #toast-container { top: 10px; right: 10px; left: 10px; }
 .toast { width: 100%; }
 }

 /* Animation */
 .fade-in {
 animation: fadeIn 0.4s ease-in-out;
 }
 @keyframes fadeIn {
 from { opacity: 0; transform: translateY(15px); }
 to { opacity: 1; transform: translateY(0); }
 }
 </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2><i class="fa-regular fa-gem"></i> Qu·∫£n l√Ω kim c∆∞∆°ng Lineage2M</h2>
        <p>Theo d√µi v√† qu·∫£n l√Ω kim c∆∞∆°ng c·ªßa b·∫°n m·ªôt c√°ch d·ªÖ d√†ng v·ªõi Google Sheets</p>
        <div id="connectionStatus" class="status-indicator status-loading">
            <div class="loading-spinner"></div>
            <span>ƒêang k·∫øt n·ªëi...</span>
        </div>
    </div>

    <div class="card form-section">
        <input type="hidden" id="editIndex" value="">
        <div class="input-group">
            <input type="text" id="account" placeholder="T√™n account">
            <input type="text" id="server" placeholder="Server (v√≠ d·ª•: B9, L9)" list="server-list">
            <datalist id="server-list"></datalist>
            <input type="number" id="current" placeholder="Kim c∆∞∆°ng hi·ªán t·∫°i">
        </div>
        <div class="form-buttons">
            <button class="btn btn-primary" onclick="addOrUpdate()" id="saveBtn">
                <i class="fa-solid fa-save"></i> L∆∞u / C·∫≠p nh·∫≠t
            </button>
            <button class="btn btn-danger" onclick="resetAll()" id="resetBtn">
                <i class="fa-solid fa-trash-alt"></i> Xo√° t·∫•t c·∫£
            </button>
        </div>
    </div>

    <div class="card controls-section">
        <input type="search" id="searchInput" placeholder="T√¨m theo t√™n account ho·∫∑c server..." onkeyup="handleSearch()">
        <div class="controls-buttons">
            <button class="btn btn-secondary" onclick="refreshData()" id="refreshBtn">
                <i class="fa-solid fa-sync-alt"></i> L√†m m·ªõi d·ªØ li·ªáu
            </button>
            <button class="btn btn-secondary" onclick="exportData()">
                <i class="fa-solid fa-file-export"></i> Xu·∫•t D·ªØ Li·ªáu (JSON)
            </button>
        </div>
    </div>
    
    <div id="serverTables"></div>
    <div id="toast-container"></div>
</div>

<script>
// URL c·ªßa Google Apps Script (thay b·∫±ng URL th·ª±c t·∫ø c·ªßa b·∫°n)
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxL4zQFzKXBw0QYClySyWAxG9x_qebpVj-BACbGP5dUsP074JyGwRK8BdImgdOIKSI/exec';

// JSONP helper function
function jsonp(url, params = {}, timeout = 30000) {
  return new Promise((resolve, reject) => {
    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
    
    // Add callback parameter
    params.callback = callbackName;
    
    // Build URL with parameters
    const urlParams = new URLSearchParams(params);
    const fullUrl = url + '?' + urlParams.toString();
    
    // Create script element
    const script = document.createElement('script');
    script.src = fullUrl;
    
    // Set timeout
    const timeoutId = setTimeout(() => {
      cleanup();
      reject(new Error('JSONP request timeout'));
    }, timeout);
    
    // Global callback function
    window[callbackName] = function(data) {
      cleanup();
      resolve(data);
    };
    
    // Cleanup function
    function cleanup() {
      clearTimeout(timeoutId);
      document.head.removeChild(script);
      delete window[callbackName];
    }
    
    // Handle script error
    script.onerror = function() {
      cleanup();
      reject(new Error('JSONP script loading failed'));
    };
    
    // Add script to head
    document.head.appendChild(script);
  });
}

// API call functions
async function loadData() {
  try {
    console.log('Loading data...');
    updateStatus('ƒêang t·∫£i d·ªØ li·ªáu...', 'loading');
    
    const result = await jsonp(SCRIPT_URL, { action: 'getData' });
    
    if (result.error) {
      throw new Error(result.error);
    }
    
    console.log('Data loaded:', result);
    
    // Clear existing data
    gameData.length = 0;
    
    // Add loaded data
    if (Array.isArray(result) && result.length > 0) {
      gameData.push(...result);
      updateStatus(`ƒê√£ t·∫£i ${result.length} t√†i kho·∫£n`, 'success');
    } else {
      updateStatus('Kh√¥ng c√≥ d·ªØ li·ªáu', 'info');
    }
    
    renderTable();
    
  } catch (error) {
    console.error('Load data error:', error);
    updateStatus('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
  }
}

async function saveData() {
  try {
    console.log('Saving data...', gameData);
    updateStatus('ƒêang l∆∞u d·ªØ li·ªáu...', 'loading');
    
    const dataToSave = JSON.stringify(gameData);
    
    const result = await jsonp(SCRIPT_URL, { 
      action: 'saveData', 
      data: encodeURIComponent(dataToSave)
    });
    
    if (result.error) {
      throw new Error(result.error);
    }
    
    console.log('Data saved:', result);
    updateStatus('ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
    
  } catch (error) {
    console.error('Save data error:', error);
    updateStatus('L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message, 'error');
  }
}

// Status update function
function updateStatus(message, type = 'info') {
  const statusElement = document.getElementById('status');
  if (statusElement) {
    statusElement.textContent = message;
    statusElement.className = 'status ' + type;
    
    // Auto clear success/info messages after 3 seconds
    if (type === 'success' || type === 'info') {
      setTimeout(() => {
        if (statusElement.textContent === message) {
          statusElement.textContent = 'S·∫µn s√†ng';
          statusElement.className = 'status';
        }
      }, 3000);
    }
  }
  console.log(`Status: ${message} (${type})`);
}

// Remove ServiceWorker registration to fix the error
// Comment out or remove this block in your HTML:
/*
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => console.log('SW registered'))
    .catch(error => console.log('SW registration failed:', error));
}
*/

// Example usage - replace your existing event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Load data on page load
  loadData();
  
  // Save button
  const saveBtn = document.getElementById('saveBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveData);
  }
  
  // Refresh button
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadData);
  }
});

// ===== BI·∫æN TO√ÄN C·ª§C =====
let data = [];
let isOnline = false;
let isLoading = false;

// ===== KH·ªûI T·∫†O =====
document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

// ===== QU·∫¢N L√ù K·∫æT N·ªêI =====
function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    
    statusElement.className = 'status-indicator';
    
    switch(status) {
        case 'loading':
            statusElement.classList.add('status-loading');
            statusElement.innerHTML = '<div class="loading-spinner"></div><span>ƒêang k·∫øt n·ªëi...</span>';
            isOnline = false;
            isLoading = true;
            break;
        case 'online':
            statusElement.classList.add('status-online');
            statusElement.innerHTML = '<i class="fa-solid fa-check-circle"></i><span>ƒê√£ k·∫øt n·ªëi Google Sheets</span>';
            isOnline = true;
            isLoading = false;
            break;
        case 'offline':
            statusElement.classList.add('status-offline');
            statusElement.innerHTML = '<i class="fa-solid fa-times-circle"></i><span>M·∫•t k·∫øt n·ªëi - Ch·∫ø ƒë·ªô offline</span>';
            isOnline = false;
            isLoading = false;
            break;
    }
    
    // Disable/enable buttons based on connection status
    const buttonsToDisable = [saveBtn, resetBtn, refreshBtn];
    buttonsToDisable.forEach(btn => {
        if (btn) {
            btn.disabled = isLoading;
        }
    });
}

// ===== API CALLS =====
async function apiCall(action, requestData = null) {
    try {
        updateConnectionStatus('loading');
        
        let url = `${GOOGLE_SCRIPT_URL}?action=${action}`;
        let options = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        };
        
        if (requestData) {
            options.method = 'POST';
            options.body = JSON.stringify({
                action: action,
                data: requestData
            });
        }
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        updateConnectionStatus('online');
        return result;
        
    } catch (error) {
        console.error('API Call Error:', error);
        updateConnectionStatus('offline');
        
        // Fallback to in-memory data for offline mode
        if (action === 'getData') {
            return data;
        }
        
        throw error;
    }
}

async function loadData() {
    try {
        const result = await apiCall('getData');
        data = Array.isArray(result) ? result : [];
        render();
        showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ Google Sheets!', 'success');
    } catch (error) {
        console.error('Load data error:', error);
        showToast('Kh√¥ng th·ªÉ k·∫øt n·ªëi Google Sheets. S·ª≠ d·ª•ng d·ªØ li·ªáu offline.', 'danger');
        render();
    }
}

async function saveToCloud() {
    try {
        await apiCall('saveData', data);
        return true;
    } catch (error) {
        console.error('Save data error:', error);
        throw error;
    }
}

// ===== UI FUNCTIONS =====
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
    toast.innerHTML = `<i class="fa-solid ${iconClass}"></i> ${message}`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

function render(dataToRender = data) {
    const serverTables = document.getElementById("serverTables");
    serverTables.innerHTML = "";
    
    // Update server list for datalist
    const existingServers = [...new Set(data.map(item => item.server))];
    const serverList = document.getElementById('server-list');
    serverList.innerHTML = existingServers.map(s => `<option value="${s}"></option>`).join('');
    
    // Group data by server
    const grouped = {};
    dataToRender.forEach((item) => {
        if (!grouped[item.server]) grouped[item.server] = [];
        grouped[item.server].push(item);
    });
    
    if (Object.keys(grouped).length === 0) {
        const searchTerm = document.getElementById('searchInput').value;
        const emptyText = searchTerm 
            ? `Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o cho "<b>${searchTerm}</b>"` 
            : `<div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div>
               <div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o</div>
               <div class="empty-state-subtext">H√£y th√™m account ƒë·∫ßu ti√™n c·ªßa b·∫°n!</div>`;
        
        serverTables.innerHTML = `<div class="empty-state fade-in">${emptyText}</div>`;
        return;
    }
    
    // Create tables for each server
    Object.keys(grouped).sort().forEach(server => {
        const serverData = grouped[server];
        const total = serverData.reduce((sum, item) => sum + item.current, 0);
        
        const section = document.createElement('div');
        section.className = 'server-section fade-in';
        
        section.innerHTML = `
            <div class="server-header">
                <span><i class="fa-solid fa-server"></i> Server ${server}</span>
                <div class="server-stats">${total.toLocaleString('vi-VN')} üíé</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Kim c∆∞∆°ng</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    ${serverData.map((item, index) => `
                        <tr>
                            <td class="account-name">${item.account}</td>
                            <td class="diamond-count" onclick="editInline(this, '${item.account}', '${item.server}')">${item.current.toLocaleString('vi-VN')}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editItem('${item.account}', '${item.server}')">
                                        <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button class="btn-small btn-delete" onclick="deleteItem('${item.account}', '${item.server}')">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        serverTables.appendChild(section);
    });
}

// ===== DATA MANAGEMENT =====
async function addOrUpdate() {
    const account = document.getElementById('account').value.trim();
    const server = document.getElementById('server').value.trim();
    const current = parseInt(document.getElementById('current').value) || 0;
    const editIndex = document.getElementById('editIndex').value;
    
    if (!account || !server) {
        showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n account v√† server!', 'danger');
        return;
    }
    
    try {
        if (editIndex !== '') {
            // Update existing item
            const index = parseInt(editIndex);
            if (data[index]) {
                data[index] = { account, server, current };
                showToast(`ƒê√£ c·∫≠p nh·∫≠t ${account}!`, 'success');
            }
        } else {
            // Check if account + server combination already exists
            const existingIndex = data.findIndex(item => 
                item.account.toLowerCase() === account.toLowerCase() && 
                item.server.toLowerCase() === server.toLowerCase()
            );
            
            if (existingIndex !== -1) {
                data[existingIndex] = { account, server, current };
                showToast(`ƒê√£ c·∫≠p nh·∫≠t ${account} tr√™n server ${server}!`, 'success');
            } else {
                data.push({ account, server, current });
                showToast(`ƒê√£ th√™m ${account} tr√™n server ${server}!`, 'success');
            }
        }
        
        // Try to save to cloud
        if (isOnline) {
            await saveToCloud();
        }
        
        clearForm();
        render();
        
    } catch (error) {
        showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'danger');
        console.error('Save error:', error);
    }
}

function editItem(account, server) {
    const item = data.find(d => d.account === account && d.server === server);
    if (item) {
        document.getElementById('account').value = item.account;
        document.getElementById('server').value = item.server;
        document.getElementById('current').value = item.current;
        document.getElementById('editIndex').value = data.findIndex(d => d.account === account && d.server === server);
        document.getElementById('account').focus();
    }
}

async function deleteItem(account, server) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${account} (${server})?`)) {
        try {
            data = data.filter(item => !(item.account === account && item.server === server));
            
            // Try to save to cloud
            if (isOnline) {
                await saveToCloud();
            }
            
            render();
            showToast(`ƒê√£ x√≥a ${account}!`, 'success');
        } catch (error) {
            showToast('C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu!', 'danger');
            console.error('Delete error:', error);
        }
    }
}

function editInline(cell, account, server) {
    const currentValue = data.find(d => d.account === account && d.server === server)?.current || 0;
    const input = document.createElement('input');
    input.type = 'number';
    input.value = currentValue;
    input.className = 'diamond-count';
    input.onblur = () => saveInlineEdit(input, account, server);
    input.onkeypress = (e) => {
        if (e.key === 'Enter') {
            input.blur();
        }
    };
    
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
    input.select();
}

async function saveInlineEdit(input, account, server) {
    const newValue = parseInt(input.value) || 0;
    const item = data.find(d => d.account === account && d.server === server);
    
    if (item) {
        item.current = newValue;
        
        try {
            // Try to save to cloud
            if (isOnline) {
                await saveToCloud();
            }
            render();
            showToast(`ƒê√£ c·∫≠p nh·∫≠t kim c∆∞∆°ng cho ${account}!`, 'success');
        } catch (error) {
            showToast('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!', 'danger');
            console.error('Update error:', error);
        }
    }
}

async function resetAll() {
    if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
        try {
            data = [];
            
            // Try to save to cloud
            if (isOnline) {
                await saveToCloud();
            }
            
            render();
            clearForm();
            showToast('ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!', 'success');
        } catch (error) {
            showToast('C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu!', 'danger');
            console.error('Delete error:', error);
        }
    }
}

function clearForm() {
    document.getElementById('account').value = '';
    document.getElementById('server').value = '';
    document.getElementById('current').value = '';
    document.getElementById('editIndex').value = '';
}

// ===== SEARCH FUNCTIONALITY =====
function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (searchTerm === '') {
        render(data);
        return;
    }
    
    const filteredData = data.filter(item => 
        item.account.toLowerCase().includes(searchTerm) || 
        item.server.toLowerCase().includes(searchTerm)
    );
    
    render(filteredData);
}

// ===== REFRESH DATA =====
async function refreshData() {
    try {
        updateConnectionStatus('loading');
        const result = await apiCall('getData');
        data = Array.isArray(result) ? result : [];
        render();
        showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi t·ª´ Google Sheets!', 'success');
    } catch (error) {
        console.error('Refresh data error:', error);
        showToast('Kh√¥ng th·ªÉ l√†m m·ªõi d·ªØ li·ªáu t·ª´ Google Sheets!', 'danger');
    }
}

// ===== EXPORT DATA =====
function exportData() {
    if (data.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'danger');
        return;
    }
    
    try {
        const exportData = {
            exportDate: new Date().toLocaleString('vi-VN'),
            totalAccounts: data.length,
            totalDiamonds: data.reduce((sum, item) => sum + item.current, 0),
            servers: [...new Set(data.map(item => item.server))],
            accounts: data
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `kim-cuong-export-${new Date().toISOString().slice(0, 10)}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
    } catch (error) {
        console.error('Export error:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi xu·∫•t d·ªØ li·ªáu!', 'danger');
    }
}

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + Enter ƒë·ªÉ l∆∞u form
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        addOrUpdate();
    }
    
    // Escape ƒë·ªÉ clear form
    if (e.key === 'Escape') {
        clearForm();
        document.getElementById('searchInput').value = '';
        render();
    }
    
    // Ctrl/Cmd + R ƒë·ªÉ refresh (override default)
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        refreshData();
    }
});

// ===== AUTO-SAVE FUNCTIONALITY =====
let autoSaveTimeout;
function scheduleAutoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(async () => {
        if (isOnline && data.length > 0) {
            try {
                await saveToCloud();
                console.log('Auto-save completed');
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }
    }, 30000); // Auto-save after 30 seconds of inactivity
}

// ===== PERIODIC SYNC =====
setInterval(async () => {
    if (isOnline) {
        try {
            const cloudData = await apiCall('getData');
            if (JSON.stringify(cloudData) !== JSON.stringify(data)) {
                console.log('Data sync detected differences');
                // Optionally show a notification about data changes
            }
        } catch (error) {
            console.error('Periodic sync failed:', error);
        }
    }
}, 60000); // Check every minute

// ===== SERVICE WORKER REGISTRATION (for offline support) =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful');
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
    });
}

// ===== ONLINE/OFFLINE DETECTION =====
window.addEventListener('online', function() {
    console.log('Connection restored');
    loadData(); // Reload data when connection is restored
});

window.addEventListener('offline', function() {
    console.log('Connection lost');
    updateConnectionStatus('offline');
});

// ===== INITIALIZE ON LOAD =====
window.addEventListener('load', function() {
    // Check initial connection status
    if (navigator.onLine) {
        loadData();
    } else {
        updateConnectionStatus('offline');
        render();
    }
});
</script>
