<!DOCTYPE html>
<html lang="vi">
<head>
 <meta charset="UTF-8">
 <title>Quản Lý Kim Cương</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <style>
 :root {
 --primary-color: #4f46e5;
 --danger-color: #ff6b6b;
 --success-color: #10b981;
 --warning-color: #f59e0b;
 --info-color: #3b82f6; /* MỚI: Màu cho nút reset */
 --background-dark1: #1a1a2e;
 --background-dark2: #16213e;
 --background-dark3: #0f3460;
 --white: #ffffff;
 --light-gray: #f8f9fa;
 --medium-gray: #e0e6ed;
 --dark-gray: #374151;
 --text-color: #333;
 }
 
 * { box-sizing: border-box; }
 
 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
 margin: 0; padding: 0;
 background: linear-gradient(135deg, var(--background-dark1) 0%, var(--background-dark2) 50%, var(--background-dark3) 100%);
 min-height: 100vh; color: var(--text-color);
 }

 .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
 .header { text-align: center; margin-bottom: 30px; color: var(--white); }
 .header h2 { font-size: 2.5rem; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 700; }
 .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1rem; }

 .card {
 background: var(--white); border-radius: 20px; padding: 30px;
 margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray); transition: transform 0.2s ease, box-shadow 0.2s ease;
 }
 .card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
 .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
 .form-section input[type="text"], .form-section input[type="number"], .controls-section input[type="search"] {
 width: 100%; padding: 16px 20px; font-size: 16px;
 border: 2px solid #e1e5e9; border-radius: 12px;
 background: var(--white); transition: all 0.3s ease; outline: none;
 }
 .form-section input:focus, .controls-section input:focus {
 border-color: var(--primary-color);
 box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
 transform: translateY(-1px);
 }
 .form-section input::placeholder, .controls-section input::placeholder { color: #a0a8b0; }
 .form-buttons, .controls-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
 .btn {
 flex: 1; min-width: 160px; padding: 16px 24px; font-size: 16px;
 font-weight: 600; border: none; border-radius: 12px; cursor: pointer;
 transition: all 0.3s ease; text-decoration: none; display: inline-flex;
 align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden;
 }
 .btn::before {
 content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
 background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
 transition: left 0.5s;
 }
 .btn:hover::before { left: 100%; }
 .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
 .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4); }
 .btn-danger { background: linear-gradient(135deg, var(--danger-color), #ee5a52); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
 .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }
 .btn-secondary { background: linear-gradient(135deg, #64748b, #475569); color: white; box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3); }
 .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4); }

 .server-section {
 background: var(--white); border-radius: 20px; margin-bottom: 25px;
 overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray); transition: transform 0.2s ease;
 }
 .server-section:hover { transform: translateY(-2px); }
 .server-header {
 background: linear-gradient(135deg, #1f2937, var(--dark-gray)); color: white;
 padding: 20px 30px; font-size: 1.3rem; font-weight: 600;
 display: flex; align-items: center; justify-content: space-between; gap: 10px;
 }
 .server-stats {
 background: var(--primary-color); padding: 8px 16px; border-radius: 20px;
 font-size: 1.1rem; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
 }

 table { width: 100%; border-collapse: collapse; font-size: 15px; background: var(--white); }
 th, td { padding: 16px 10px; text-align: center; border-bottom: 1px solid #f0f0f0; }
 th { background: var(--light-gray); color: #555; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
 tbody tr { transition: background-color 0.2s ease; }
 tbody tr:hover { background: var(--light-gray); }

 .account-name { font-weight: 600; color: var(--text-color); }
 .diamond-count {
 font-weight: 700; color: var(--primary-color); font-size: 1.1rem;
 cursor: pointer; border-radius: 8px; transition: background-color 0.2s ease;
 }
 .diamond-count:hover { background-color: #f0f8ff; }
 .diamond-count input {
 width: 100px; text-align: center; border: 1px solid var(--primary-color);
 border-radius: 5px; padding: 5px; font-size: 1rem; font-weight: 700;
 }
 .performance-change { font-size: 0.9rem; font-weight: 600; }
 .change-positive { color: var(--success-color); }
 .change-negative { color: var(--danger-color); }

 .action-buttons { display: flex; gap: 8px; justify-content: center; }
 .btn-small {
 width: 36px; height: 36px; padding: 8px; font-size: 14px;
 border: none; border-radius: 8px; cursor: pointer;
 transition: all 0.2s ease; font-weight: 500;
 display: inline-flex; align-items: center; justify-content: center;
 }
 .btn-sync { background-color: var(--info-color); color: white; }
 .btn-sync:hover { background: #2563eb; transform: scale(1.05); }
 .btn-history { background-color: #64748b; color: white; }
 .btn-history:hover { background: #475569; transform: scale(1.05); }
 .btn-edit { background: var(--warning-color); color: white; }
 .btn-edit:hover { background: #d97706; transform: scale(1.05); }
 .btn-delete { background: var(--danger-color); color: white; }
 .btn-delete:hover { background: #ee5a52; transform: scale(1.05); }

 .empty-state {
 text-align: center; padding: 60px 20px; background: var(--white);
 border-radius: 20px; color: #666;
 }
 .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; color: var(--primary-color); }

 #toast-container {
 position: fixed; top: 20px; right: 20px; z-index: 9999;
 display: flex; flex-direction: column; gap: 10px;
 }
 .toast {
 background-color: var(--dark-gray); color: white; padding: 15px 20px;
 border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
 display: flex; align-items: center; gap: 10px; opacity: 0;
 transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
 }
 .toast.show { opacity: 1; transform: translateX(0); }
 .toast.toast-success { background-color: var(--success-color); }
 .toast.toast-danger { background-color: var(--danger-color); }
 .toast.toast-info { background-color: var(--info-color); }

 /* --- CSS CHO MODAL --- */
 .modal {
 position: fixed; z-index: 1000; left: 0; top: 0;
 width: 100%; height: 100%; overflow: auto;
 background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
 display: none; align-items: center; justify-content: center;
 }
 .modal.active { display: flex; }
 .modal-content {
 background-color: #fefefe; margin: auto; padding: 20px;
 border: 1px solid #888; width: 90%; max-width: 700px;
 border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s;
 }
 .modal-header {
 padding: 10px 15px; border-bottom: 1px solid #e5e5e5;
 display: flex; justify-content: space-between; align-items: center;
 }
 .modal-header h2 { margin: 0; font-size: 1.5rem; }
 .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
 .close-btn:hover, .close-btn:focus { color: black; }
 .modal-body { padding: 15px; }
 #noteModal .modal-body { display: flex; flex-direction: column; gap: 15px; }
 #noteModal #noteModalInfo { font-size: 1.1rem; text-align: center; }
 #noteModal #noteInput {
    width: 100%; padding: 12px; font-size: 1rem;
    border-radius: 8px; border: 1px solid #ccc;
 }
 .modal-actions {
    display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px;
    border-top: 1px solid #e5e5e5;
 }
 .modal-actions .btn { min-width: 120px; flex: 0; }
 
 #historyModal .modal-body { max-height: 60vh; overflow-y: auto; }
 .history-table { width: 100%; border-collapse: collapse; }
 .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
 .history-table th { background-color: #f2f2f2; }
 .history-table .note-col { max-width: 200px; word-wrap: break-word; }

 @media (max-width: 768px) {
 .container { padding: 15px; }
 .header h2 { font-size: 2rem; }
 .card { padding: 20px; border-radius: 16px; }
 .input-group, .controls-section { grid-template-columns: 1fr; gap: 15px; }
 .form-buttons, .controls-buttons { flex-direction: column; }
 .btn { min-width: auto; }
 .server-header { padding: 15px 20px; font-size: 1.1rem; flex-direction: column; align-items: stretch; gap: 8px; }
 .server-stats { text-align: center; }
 th, td { padding: 12px 5px; font-size: 13px; }
 .action-buttons { flex-wrap: wrap; }
 #toast-container { top: 10px; right: 10px; left: 10px; }
 .toast { width: 100%; }
 .modal-content { width: 95%; max-width: 450px; }
 }
 @media (max-width: 480px) {
    th, td { font-size: 12px; }
    .action-buttons { gap: 4px; }
    .btn-small { width: 32px; height: 32px; }
 }

 /* Animation */
 .fade-in { animation: fadeIn 0.4s ease-in-out; }
 @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
 </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2><i class="fa-regular fa-gem"></i> Diamonds Lineage2M</h2>
        <p>Theo dõi và quản lý kim cương của bạn một cách dễ dàng</p>
    </div>

    <div class="card form-section">
        <input type="hidden" id="editIndex" value="">
        <div class="input-group">
            <input type="text" id="account" placeholder="Tên account">
            <input type="text" id="server" placeholder="Server (ví dụ: B9, L9)" list="server-list">
            <datalist id="server-list"></datalist>
            <input type="number" id="current" placeholder="Kim cương khởi tạo">
        </div>
        <div class="form-buttons">
            <button class="btn btn-primary" onclick="addOrUpdate()"><i class="fa-solid fa-save"></i> Lưu / Cập nhật</button>
            <button class="btn btn-danger" onclick="resetAll()"><i class="fa-solid fa-trash-alt"></i> Xoá tất cả</button>
        </div>
    </div>

    <div class="card controls-section">
        <input type="search" id="searchInput" placeholder="Tìm theo tên account hoặc server..." onkeyup="handleSearch()">
        <div class="controls-buttons">
            <button class="btn btn-secondary" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Xuất Dữ Liệu (JSON)</button>
            <button class="btn btn-secondary" onclick="triggerImport()"><i class="fa-solid fa-file-import"></i> Nhập Dữ Liệu (JSON)</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
        </div>
    </div>
    
    <div id="serverTables"></div>
    <div id="toast-container"></div>

    <!-- MODAL LỊCH SỬ GIAO DỊCH -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">Lịch sử giao dịch</h2>
                <span class="close-btn" onclick="closeHistoryModal()">×</span>
            </div>
            <div class="modal-body">
                <table class="history-table">
                    <thead><tr><th>Thời gian</th><th>Thay đổi</th><th class="note-col">Ghi chú</th><th>Số dư sau GD</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL NHẬP GHI CHÚ -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ghi chú thay đổi</h2>
                <span class="close-btn" onclick="closeNoteModal()">×</span>
            </div>
            <div class="modal-body">
                <p id="noteModalInfo"></p>
                <input type="text" id="noteInput" placeholder="Nhập ghi chú...">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeNoteModal()">Hủy</button>
                <button class="btn btn-primary" onclick="confirmNoteChange()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("kimcuong_data_v3")) || [];
let _noteModalState = {};

function migrateData() {
    let needsSave = false;
    data.forEach(item => {
        if (!item.hasOwnProperty('history')) {
            item.history = [{
                timestamp: new Date().toISOString(), type: 'set', amount: item.current,
                note: 'Dữ liệu được khởi tạo từ phiên bản cũ', oldBalance: 0, newBalance: item.current
            }];
            needsSave = true;
        }
        // Thêm trường mới cho dữ liệu cũ
        if (!item.hasOwnProperty('performanceResetTimestamp')) {
            item.performanceResetTimestamp = null;
            needsSave = true;
        }
    });
    if (needsSave) save();
}

function save() { localStorage.setItem("kimcuong_data_v3", JSON.stringify(data)); }
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const iconClassMap = { success: 'fa-check-circle', danger: 'fa-times-circle', info: 'fa-info-circle'};
    toast.innerHTML = `<i class="fa-solid ${iconClassMap[type]}"></i> ${message}`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

// *** TỐI ƯU HÓA: Hàm tính hiệu suất chung ***
function calculatePerformance(history, days, resetTimestamp) {
    if (history.length === 0) return 0;

    const now = new Date();
    let startDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
    
    // Nếu có điểm reset và điểm đó mới hơn startDate, dùng điểm reset
    if (resetTimestamp && new Date(resetTimestamp) > startDate) {
        startDate = new Date(resetTimestamp);
    }
    
    let balanceAtStartDate = history[history.length - 1].newBalance; // Mặc định là số dư ban đầu
    for (const entry of history) {
        if (new Date(entry.timestamp) > startDate) {
            balanceAtStartDate = entry.oldBalance;
        } else {
            break; 
        }
    }
    const currentBalance = history[0].newBalance;
    return currentBalance - balanceAtStartDate;
}

function renderPerformance(change) {
    if (change > 0) return `<span class="performance-change change-positive"><i class="fa-solid fa-arrow-up"></i> ${change.toLocaleString()}</span>`;
    if (change < 0) return `<span class="performance-change change-negative"><i class="fa-solid fa-arrow-down"></i> ${Math.abs(change).toLocaleString()}</span>`;
    return `<span class="performance-change">--</span>`;
}


function render(dataToRender = data) {
    const serverTables = document.getElementById("serverTables");
    serverTables.innerHTML = "";
    const existingServers = [...new Set(data.map(item => item.server))];
    const serverList = document.getElementById('server-list');
    serverList.innerHTML = existingServers.map(s => `<option value="${s}"></option>`).join('');
    const grouped = {};
    dataToRender.forEach((item) => {
        if (!grouped[item.server]) grouped[item.server] = [];
        grouped[item.server].push(item);
    });
    if (Object.keys(grouped).length === 0) {
        const searchTerm = document.getElementById('searchInput').value;
        const emptyText = searchTerm 
            ? `Không tìm thấy kết quả nào cho "<b>${searchTerm}</b>"` 
            : `<div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div><div class="empty-state-text">Chưa có dữ liệu nào</div><div class="empty-state-subtext">Hãy thêm account đầu tiên của bạn</div>`;
        serverTables.innerHTML = `<div class="empty-state">${emptyText}</div>`;
    } else {
        Object.keys(grouped).sort().forEach(server => {
            grouped[server].sort((a, b) => b.current - a.current);
            const rows = grouped[server].map(item => {
                const originalIndex = data.findIndex(x => x.account === item.account && x.server === item.server);
                
                const change24h = calculatePerformance(item.history, 1, item.performanceResetTimestamp);
                const change7d = calculatePerformance(item.history, 7, item.performanceResetTimestamp);
                
                return `
                    <tr class="fade-in">
                        <td class="account-name">${item.account}</td>
                        <td class="diamond-count" onclick="makeEditable(this, ${originalIndex})">
                            <span>${item.current.toLocaleString()}</span>
                        </td>
                        <td>${renderPerformance(change24h)}</td>
                        <td>${renderPerformance(change7d)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-sync" onclick="resetPerformance(${originalIndex})" title="Reset hiệu suất"><i class="fa-solid fa-sync-alt"></i></button>
                                <button class="btn-small btn-history" onclick="showHistory(${originalIndex})" title="Xem lịch sử"><i class="fa-solid fa-history"></i></button>
                                <button class="btn-small btn-edit" onclick="edit(${originalIndex})" title="Chỉnh sửa tên/server"><i class="fa-solid fa-pencil"></i></button>
                                <button class="btn-small btn-delete" onclick="del(${originalIndex})" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            }).join("");
            const total = grouped[server].reduce((sum, item) => sum + item.current, 0);
            serverTables.innerHTML += `
                <div class="server-section fade-in">
                    <div class="server-header">
                        <span><i class="fa-solid fa-server"></i> Server: ${server} (${grouped[server].length} acc)</span>
                        <div class="server-stats">${total.toLocaleString()} KC</div>
                    </div>
                    <table>
                        <thead><tr><th>Account</th><th>Kim cương</th><th>HS 24h</th><th>HS 7 ngày</th><th>Hành động</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        });
    }
}

function addOrUpdate() {
    const account = document.getElementById("account").value.trim();
    const server = document.getElementById("server").value.trim().toUpperCase();
    const currentStr = document.getElementById("current").value;
    const current = currentStr ? parseInt(currentStr) : NaN;
    const editIndex = document.getElementById("editIndex").value;
    if (!account || !server) { alert("Vui lòng nhập Tên account và Server!"); return; }
    
    let isUpdating = false;
    if (editIndex !== "") {
        if (!isNaN(current) && current < 0) { alert("Số kim cương không thể âm!"); return; }
        const originalItem = data[parseInt(editIndex)];
        const isDuplicate = data.some((item, index) => 
            item.account === account && item.server === server && index != parseInt(editIndex));
        if(isDuplicate) { alert(`Lỗi! Account "${account}" đã tồn tại trên server "${server}".`); return; }
        originalItem.account = account; originalItem.server = server;
        if (!isNaN(current)) addHistoryEntry(parseInt(editIndex), current, 'Cập nhật thủ công');
        isUpdating = true;
    } else {
        if (isNaN(current)) { alert("Vui lòng nhập Kim cương khởi tạo!"); return; }
        if (current < 0) { alert("Số kim cương không thể âm!"); return; }
        const isDuplicate = data.some(item => item.account === account && item.server === server);
        if (isDuplicate) { alert(`Account "${account}" đã tồn tại trên server "${server}".`); return; }
        const newItem = { account, server, current, history: [], performanceResetTimestamp: null };
        data.push(newItem);
        const newIndex = data.length - 1;
        addHistoryEntry(newIndex, current, 'Khởi tạo tài khoản');
    }
    save(); render();
    showToast(`Account đã được ${isUpdating ? 'cập nhật' : 'thêm mới'}!`, 'success');
    clearForm();
}

function edit(index) {
    const item = data[index];
    document.getElementById("editIndex").value = index;
    document.getElementById("account").value = item.account;
    document.getElementById("server").value = item.server;
    document.getElementById("current").placeholder = `KC hiện tại: ${item.current.toLocaleString()} (để trống nếu không đổi)`;
    document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
    document.getElementById("account").focus();
}

function del(index) {
    const item = data[index];
    if (confirm(`Bạn có chắc muốn xoá account "${item.account}" (${item.server})?`)) {
        data.splice(index, 1); save(); render();
        showToast(`Đã xóa account "${item.account}"`, 'danger');
        clearForm();
    }
}

function resetAll() {
    if (confirm("BẠN CÓ CHẮC MUỐN XOÁ TOÀN BỘ DỮ LIỆU?\n\nHành động này không thể hoàn tác!")) {
        data = []; save(); render();
        showToast("Đã xóa toàn bộ dữ liệu!", 'danger');
        clearForm();
    }
}

function clearForm() {
    document.getElementById("account").value = "";
    document.getElementById("server").value = "";
    document.getElementById("current").value = "";
    document.getElementById("editIndex").value = "";
    document.getElementById("current").placeholder = "Kim cương khởi tạo";
    document.getElementById("account").focus();
}

function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filteredData = data.filter(item => 
        item.account.toLowerCase().includes(searchTerm) || item.server.toLowerCase().includes(searchTerm));
    render(filteredData);
}

function makeEditable(tdElement, index) {
    if (tdElement.querySelector('input')) return;
    const originalValue = data[index].current;
    tdElement.innerHTML = `<input type="number" value="${originalValue}" />`;
    const input = tdElement.querySelector('input');
    input.focus(); input.select();

    input.onblur = () => saveDirectEdit(input, index);
    input.onkeydown = (e) => {
        if (e.key === 'Enter') e.target.blur();
        else if (e.key === 'Escape') render(); 
    };
}

function saveDirectEdit(input, index) {
    if (!document.body.contains(input)) return;
    const newValue = parseInt(input.value);
    const item = data[index];
    const originalValue = item.current;

    if (isNaN(newValue) || newValue < 0) { alert("Số kim cương không hợp lệ!"); render(); return; }
    if (newValue === originalValue) { render(); return; }

    const change = newValue - originalValue;
    let defaultNote = (change > 0) ? "Bán vật phẩm" : "Mua vật phẩm";
    
    _noteModalState = { index, newValue };
    document.getElementById('noteModalInfo').innerHTML = 
        `Thay đổi KC từ <b>${originalValue.toLocaleString()}</b> thành <b>${newValue.toLocaleString()}</b> (${change > 0 ? '+' : ''}${change.toLocaleString()})`;
    const noteInput = document.getElementById('noteInput');
    noteInput.value = defaultNote;
    document.getElementById('noteModal').classList.add('active');
    noteInput.focus(); noteInput.select();
}

// *** MỚI: Hàm reset hiệu suất ***
function resetPerformance(index) {
    const item = data[index];
    if (confirm(`Bạn có chắc muốn reset lại điểm mốc tính hiệu suất cho account "${item.account}"?\n\nMọi tính toán sẽ bắt đầu lại từ bây giờ.`)) {
        item.performanceResetTimestamp = new Date().toISOString();
        save();
        render();
        showToast(`Đã reset hiệu suất cho ${item.account}`, 'info');
    }
}

function confirmNoteChange() {
    const { index, newValue } = _noteModalState;
    const note = document.getElementById('noteInput').value.trim() || 'Không có ghi chú';
    
    addHistoryEntry(index, newValue, note);
    save(); render();
    showToast(`Đã cập nhật KC cho ${data[index].account}!`);
    closeNoteModal();
}

function addHistoryEntry(index, newBalance, note) {
    const item = data[index];
    const oldBalance = item.current;
    const change = newBalance - oldBalance;
    
    let type = 'set';
    if(item.history.length > 0) { type = change > 0 ? 'add' : 'subtract'; }

    item.history.unshift({
        timestamp: new Date().toISOString(), type: type, amount: Math.abs(change),
        note: note, oldBalance: oldBalance, newBalance: newBalance
    });
    if(item.history.length > 100) item.history.pop();
    item.current = newBalance;
}

function showHistory(index) {
    const item = data[index];
    const modal = document.getElementById('historyModal');
    document.getElementById('historyModalTitle').textContent = `Nhật ký: ${item.account} (${item.server})`;
    const tableBody = document.getElementById('historyTableBody');
    tableBody.innerHTML = '';
    if (item.history.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Chưa có lịch sử giao dịch.</td></tr>';
    } else {
        item.history.forEach(entry => {
            const change = entry.newBalance - entry.oldBalance;
            let changeHTML = (entry.type === 'set') ? `<span>${change.toLocaleString()}</span>` :
                             (change > 0) ? `<span class="change-positive">+${change.toLocaleString()}</span>` :
                             `<span class="change-negative">${change.toLocaleString()}</span>`;
            tableBody.innerHTML += `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString('vi-VN')}</td>
                    <td>${changeHTML}</td>
                    <td class="note-col">${entry.note}</td>
                    <td>${entry.newBalance.toLocaleString()}</td>
                </tr>`;
        });
    }
    modal.classList.add('active');
}
function closeHistoryModal() { document.getElementById('historyModal').classList.remove('active'); }
function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
    _noteModalState = {};
    render(); 
}

function exportData() {
    if (data.length === 0) { alert("Không có dữ liệu để xuất!"); return; }
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kimcuong_data_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
function triggerImport() { document.getElementById('importFile').click(); }
function handleFileImport(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!Array.isArray(importedData) || !importedData.every(item => 'account' in item && 'server' in item && 'current' in item)) {
                throw new Error("File không đúng định dạng hoặc thiếu dữ liệu.");
            }
            if (confirm("Nhập dữ liệu sẽ GHI ĐÈ toàn bộ dữ liệu hiện tại. Bạn có chắc chắn?")) {
                data = importedData; migrateData(); save(); render();
                showToast("Nhập dữ liệu thành công!", "success");
            }
        } catch (error) { alert("Lỗi khi đọc file: " + error.message);
        } finally { event.target.value = null; }
    };
    reader.readAsText(file);
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        if (document.getElementById('noteModal').classList.contains('active')) {
            confirmNoteChange();
        } else if (e.target.closest('.form-section')) {
            addOrUpdate();
        }
    } else if (e.key === 'Escape') {
        if (document.getElementById('noteModal').classList.contains('active')) closeNoteModal();
        if (document.getElementById('historyModal').classList.contains('active')) closeHistoryModal();
    }
});
window.onclick = function(event) {
    const historyModal = document.getElementById('historyModal');
    const noteModal = document.getElementById('noteModal');
    if (event.target == historyModal) closeHistoryModal();
    if (event.target == noteModal) closeNoteModal();
}

// Khởi chạy ứng dụng
migrateData();
render();

</script>

</body>
</html>
