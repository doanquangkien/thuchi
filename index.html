<!DOCTYPE html>
<html lang="vi">
<head>
 <meta charset="UTF-8">
 <title>Quản lý kim cương v2.2 (Đã sửa lỗi)</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
 <!-- Thêm Font Awesome để có icons -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <style>
 :root {
 --primary-color: #4f46e5;
 --danger-color: #ff6b6b;
 --success-color: #10b981;
 --warning-color: #f59e0b;
 --background-dark1: #1a1a2e;
 --background-dark2: #16213e;
 --background-dark3: #0f3460;
 --white: #ffffff;
 --light-gray: #f8f9fa;
 --medium-gray: #e0e6ed;
 --dark-gray: #374151;
 --text-color: #333;
 }
 
 * {
 box-sizing: border-box;
 }
 
 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
 margin: 0;
 padding: 0;
 background: linear-gradient(135deg, var(--background-dark1) 0%, var(--background-dark2) 50%, var(--background-dark3) 100%);
 min-height: 100vh;
 color: var(--text-color);
 }

 .container {
 max-width: 1200px;
 margin: 0 auto;
 padding: 20px;
 }

 .header {
 text-align: center;
 margin-bottom: 30px;
 color: var(--white);
 }

 .header h2 {
 font-size: 2.5rem;
 margin: 0;
 text-shadow: 0 2px 4px rgba(0,0,0,0.3);
 font-weight: 700;
 }

 .header p {
 margin: 10px 0 0 0;
 opacity: 0.9;
 font-size: 1.1rem;
 }

 .card {
 background: var(--white);
 border-radius: 20px;
 padding: 30px;
 margin-bottom: 30px;
 box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray);
 transition: transform 0.2s ease, box-shadow 0.2s ease;
 }

 .card:hover {
 transform: translateY(-2px);
 box-shadow: 0 12px 40px rgba(0,0,0,0.15);
 }

 .input-group {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
 gap: 20px;
 margin-bottom: 25px;
 }

 .form-section input[type="text"],
 .form-section input[type="number"],
 .controls-section input[type="search"] {
 width: 100%;
 padding: 16px 20px;
 font-size: 16px;
 border: 2px solid #e1e5e9;
 border-radius: 12px;
 background: var(--white);
 transition: all 0.3s ease;
 outline: none;
 }

 .form-section input:focus,
 .controls-section input:focus {
 border-color: var(--primary-color);
 box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
 transform: translateY(-1px);
 }

 .form-section input::placeholder,
 .controls-section input::placeholder {
 color: #a0a8b0;
 }

 .form-buttons, .controls-buttons {
 display: flex;
 gap: 15px;
 flex-wrap: wrap;
 }

 .btn {
 flex: 1;
 min-width: 160px;
 padding: 16px 24px;
 font-size: 16px;
 font-weight: 600;
 border: none;
 border-radius: 12px;
 cursor: pointer;
 transition: all 0.3s ease;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 gap: 10px;
 position: relative;
 overflow: hidden;
 }

 .btn::before {
 content: '';
 position: absolute;
 top: 0;
 left: -100%;
 width: 100%;
 height: 100%;
 background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
 transition: left 0.5s;
 }

 .btn:hover::before {
 left: 100%;
 }

 .btn-primary {
 background: linear-gradient(135deg, #4f46e5, #7c3aed);
 color: white;
 box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
 }

 .btn-primary:hover {
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
 }

 .btn-danger {
 background: linear-gradient(135deg, var(--danger-color), #ee5a52);
 color: white;
 box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
 }

 .btn-danger:hover {
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
 }

 .btn-secondary {
 background: linear-gradient(135deg, #64748b, #475569);
 color: white;
 box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
 }

 .btn-secondary:hover {
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
 }

 .server-section {
 background: var(--white);
 border-radius: 20px;
 margin-bottom: 25px;
 overflow: hidden;
 box-shadow: 0 10px 40px rgba(0,0,0,0.15);
 border: 1px solid var(--medium-gray);
 transition: transform 0.2s ease;
 }

 .server-section:hover {
 transform: translateY(-2px);
 }

 .server-header {
 background: linear-gradient(135deg, #1f2937, var(--dark-gray));
 color: white;
 padding: 20px 30px;
 font-size: 1.3rem;
 font-weight: 600;
 display: flex;
 align-items: center;
 justify-content: space-between;
 gap: 10px;
 }
 
 .server-stats {
 background: var(--primary-color);
 padding: 8px 16px;
 border-radius: 20px;
 font-size: 1.1rem;
 font-weight: 700;
 text-shadow: 0 1px 2px rgba(0,0,0,0.2);
 }

 table {
 width: 100%;
 border-collapse: collapse;
 font-size: 15px;
 background: var(--white);
 }

 th, td {
 padding: 16px 20px;
 text-align: center;
 border-bottom: 1px solid #f0f0f0;
 }

 th {
 background: var(--light-gray);
 color: #555;
 font-weight: 600;
 font-size: 14px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 tbody tr {
 transition: background-color 0.2s ease;
 }

 tbody tr:hover {
 background: var(--light-gray);
 }

 .account-name {
 font-weight: 600;
 color: var(--text-color);
 }

 .diamond-count {
 font-weight: 700;
 color: var(--primary-color);
 font-size: 1.1rem;
 cursor: pointer;
 border-radius: 8px;
 transition: background-color 0.2s ease;
 }
 .diamond-count:hover {
    background-color: #f0f8ff;
 }
 .diamond-count input {
    width: 100px;
    text-align: center;
    border: 1px solid var(--primary-color);
    border-radius: 5px;
    padding: 5px;
    font-size: 1rem;
    font-weight: 700;
 }

 .action-buttons {
 display: flex;
 gap: 8px;
 justify-content: center;
 }

 .btn-small {
 padding: 8px 12px;
 font-size: 14px;
 border: none;
 border-radius: 8px;
 cursor: pointer;
 transition: all 0.2s ease;
 font-weight: 500;
 }

 .btn-edit {
 background: var(--warning-color);
 color: white;
 }

 .btn-edit:hover {
 background: #d97706;
 transform: scale(1.05);
 }

 .btn-delete {
 background: var(--danger-color);
 color: white;
 }

 .btn-delete:hover {
 background: #ee5a52;
 transform: scale(1.05);
 }

 .empty-state {
 text-align: center;
 padding: 60px 20px;
 background: var(--white);
 border-radius: 20px;
 color: #666;
 }

 .empty-state-icon {
 font-size: 4rem;
 margin-bottom: 20px;
 opacity: 0.5;
 color: var(--primary-color);
 }

 /* --- CSS CHO TOAST MESSAGE --- */
 #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
 }
 .toast {
    background-color: var(--dark-gray);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
 }
 .toast.show {
    opacity: 1;
    transform: translateX(0);
 }
 .toast.toast-success { background-color: var(--success-color); }
 .toast.toast-danger { background-color: var(--danger-color); }

 @media (max-width: 768px) {
 .container { padding: 15px; }
 .header h2 { font-size: 2rem; }
 .card { padding: 20px; border-radius: 16px; }
 .input-group, .controls-section { grid-template-columns: 1fr; gap: 15px; }
 .form-buttons, .controls-buttons { flex-direction: column; }
 .btn { min-width: auto; }
 .server-header { padding: 15px 20px; font-size: 1.1rem; flex-direction: column; align-items: stretch; gap: 8px; }
 .server-stats { text-align: center; }
 th, td { padding: 12px 8px; font-size: 14px; }
 .action-buttons { flex-direction: column; gap: 4px; }
 #toast-container { top: 10px; right: 10px; left: 10px; }
 .toast { width: 100%; }
 }

 /* Animation */
 .fade-in {
 animation: fadeIn 0.4s ease-in-out;
 }
 @keyframes fadeIn {
 from { opacity: 0; transform: translateY(15px); }
 to { opacity: 1; transform: translateY(0); }
 }
 </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2><i class="fa-regular fa-gem"></i> Quản lý kim cương Lineage2M</h2>
        <p>Theo dõi và quản lý kim cương của bạn một cách dễ dàng</p>
    </div>

    <div class="card form-section">
        <input type="hidden" id="editIndex" value="">
        <div class="input-group">
            <input type="text" id="account" placeholder="Tên account">
            <input type="text" id="server" placeholder="Server (ví dụ: B9, L9)" list="server-list">
            <datalist id="server-list"></datalist>
            <input type="number" id="current" placeholder="Kim cương hiện tại">
        </div>
        <div class="form-buttons">
            <button class="btn btn-primary" onclick="addOrUpdate()"><i class="fa-solid fa-save"></i> Lưu / Cập nhật</button>
            <button class="btn btn-danger" onclick="resetAll()"><i class="fa-solid fa-trash-alt"></i> Xoá tất cả</button>
        </div>
    </div>

    <div class="card controls-section">
        <input type="search" id="searchInput" placeholder="Tìm theo tên account hoặc server..." onkeyup="handleSearch()">
        <div class="controls-buttons">
            <button class="btn btn-secondary" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Xuất Dữ Liệu (JSON)</button>
            <button class="btn btn-secondary" onclick="triggerImport()"><i class="fa-solid fa-file-import"></i> Nhập Dữ Liệu (JSON)</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
        </div>
    </div>
    
    <div id="serverTables"></div>
    <div id="toast-container"></div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("kimcuong_data")) || [];

function save() {
    localStorage.setItem("kimcuong_data", JSON.stringify(data));
}

function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
    toast.innerHTML = `<i class="fa-solid ${iconClass}"></i> ${message}`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

function render(dataToRender = data) {
    const serverTables = document.getElementById("serverTables");
    serverTables.innerHTML = "";
    const existingServers = [...new Set(data.map(item => item.server))];
    const serverList = document.getElementById('server-list');
    serverList.innerHTML = existingServers.map(s => `<option value="${s}"></option>`).join('');
    const grouped = {};
    dataToRender.forEach((item) => {
        if (!grouped[item.server]) grouped[item.server] = [];
        grouped[item.server].push(item);
    });
    if (Object.keys(grouped).length === 0) {
        const searchTerm = document.getElementById('searchInput').value;
        const emptyText = searchTerm 
            ? `Không tìm thấy kết quả nào cho "<b>${searchTerm}</b>"` 
            : `<div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div><div class="empty-state-text">Chưa có dữ liệu nào</div><div class="empty-state-subtext">Hãy thêm account đầu tiên của bạn</div>`;
        serverTables.innerHTML = `<div class="empty-state">${emptyText}</div>`;
    } else {
        Object.keys(grouped).sort().forEach(server => {
            grouped[server].sort((a, b) => b.current - a.current);
            const rows = grouped[server].map(item => {
                const originalIndex = data.findIndex(x => x.account === item.account && x.server === item.server);
                return `
                    <tr class="fade-in">
                        <td class="account-name">${item.account}</td>
                        <td class="diamond-count" onclick="makeEditable(this, ${originalIndex})">
                            <span>${item.current.toLocaleString()}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="edit(${originalIndex})" title="Chỉnh sửa"><i class="fa-solid fa-pencil"></i></button>
                                <button class="btn-small btn-delete" onclick="del(${originalIndex})" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            }).join("");
            const total = grouped[server].reduce((sum, item) => sum + item.current, 0);
            serverTables.innerHTML += `
                <div class="server-section fade-in">
                    <div class="server-header">
                        <span><i class="fa-solid fa-server"></i> Server: ${server} (${grouped[server].length} acc)</span>
                        <div class="server-stats">${total.toLocaleString()} KC</div>
                    </div>
                    <table>
                        <thead><tr><th>Account</th><th>Kim cương</th><th>Hành động</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        });
    }
}

function addOrUpdate() {
    const account = document.getElementById("account").value.trim();
    const server = document.getElementById("server").value.trim().toUpperCase();
    const currentStr = document.getElementById("current").value;
    const current = currentStr ? parseInt(currentStr) : NaN;
    const editIndex = document.getElementById("editIndex").value;
    if (!account || !server || isNaN(current)) {
        alert("Vui lòng nhập đầy đủ và đúng định dạng!");
        return;
    }
    if (current < 0) {
        alert("Số kim cương không thể âm!");
        return;
    }
    let isUpdating = false;
    if (editIndex !== "") {
        const originalItem = data[parseInt(editIndex)];
        const isDuplicate = data.some((item, index) => 
            item.account === account && item.server === server && index != parseInt(editIndex)
        );
        if(isDuplicate) {
            alert(`Lỗi! Account "${account}" đã tồn tại trên server "${server}".`);
            return;
        }
        originalItem.account = account;
        originalItem.server = server;
        originalItem.current = current;
        isUpdating = true;
    } else {
        const isDuplicate = data.some(item => item.account === account && item.server === server);
        if (isDuplicate) {
            alert(`Account "${account}" đã tồn tại trên server "${server}".\nNếu muốn cập nhật, hãy bấm nút "Sửa" trong danh sách.`);
            return;
        }
        data.push({ account, server, current });
    }
    save();
    render();
    showToast(`Account đã được ${isUpdating ? 'cập nhật' : 'thêm mới'}!`, 'success');
    clearForm();
}

function edit(index) {
    const item = data[index];
    document.getElementById("editIndex").value = index;
    document.getElementById("account").value = item.account;
    document.getElementById("server").value = item.server;
    document.getElementById("current").value = item.current;
    document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
    document.getElementById("account").focus();
}

function del(index) {
    const item = data[index];
    if (confirm(`Bạn có chắc muốn xoá account "${item.account}" (${item.server})?`)) {
        data.splice(index, 1);
        save();
        render();
        showToast(`Đã xóa account "${item.account}"`, 'danger');
        clearForm();
    }
}

function resetAll() {
    if (confirm("BẠN CÓ CHẮC MUỐN XOÁ TOÀN BỘ DỮ LIỆU?\n\nHành động này không thể hoàn tác!")) {
        data = [];
        save();
        render();
        showToast("Đã xóa toàn bộ dữ liệu!", 'danger');
        clearForm();
    }
}

function clearForm() {
    document.getElementById("account").value = "";
    document.getElementById("server").value = "";
    document.getElementById("current").value = "";
    document.getElementById("editIndex").value = "";
    document.getElementById("account").focus();
}

function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filteredData = data.filter(item => 
        item.account.toLowerCase().includes(searchTerm) ||
        item.server.toLowerCase().includes(searchTerm)
    );
    render(filteredData);
}

function makeEditable(tdElement, index) {
    if (tdElement.querySelector('input')) return;
    const originalValue = data[index].current;
    tdElement.innerHTML = `<input type="number" value="${originalValue}" />`;
    const input = tdElement.querySelector('input');
    input.focus();
    input.select();

    // *** ĐÂY LÀ DÒNG CODE ĐƯỢC SỬA LỖI ***
    // Gọi hàm lưu khi click ra ngoài (blur)
    input.onblur = () => saveDirectEdit(tdElement, input, index);

    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            input.blur(); // Kích hoạt sự kiện onblur để lưu, tránh lặp code
        } else if (e.key === 'Escape') {
            e.preventDefault();
            render(); 
        }
    };
}

function saveDirectEdit(tdElement, input, index) {
    // Ngăn việc gọi hàm này 2 lần nếu input đã bị xóa
    if (!document.body.contains(input)) return;
    
    const newValueStr = input.value;
    const newValue = newValueStr ? parseInt(newValueStr) : NaN;
    const item = data[index];
    const originalValue = item.current;

    // Nếu giá trị không thay đổi thì không làm gì cả
    if(newValue === originalValue) {
        render();
        return;
    }

    if (isNaN(newValue) || newValue < 0) {
        alert("Số kim cương không hợp lệ!");
        render();
        return;
    }

    const confirmationMessage = `Bạn có muốn thay đổi kim cương cho "${item.account}" từ ${originalValue.toLocaleString()} thành ${newValue.toLocaleString()}?`;
    
    if (confirm(confirmationMessage)) {
        item.current = newValue;
        save();
        showToast(`Đã cập nhật kim cương cho ${item.account}!`);
    }

    render();
}

function exportData() {
    if (data.length === 0) {
        alert("Không có dữ liệu để xuất!");
        return;
    }
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kimcuong_data_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function triggerImport() {
    document.getElementById('importFile').click();
}

function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!Array.isArray(importedData) || !importedData.every(item => 'account' in item && 'server' in item && 'current' in item)) {
                throw new Error("File không đúng định dạng hoặc thiếu dữ liệu.");
            }
            if (confirm("Nhập dữ liệu sẽ GHI ĐÈ toàn bộ dữ liệu hiện tại. Bạn có chắc chắn?")) {
                data = importedData;
                save();
                render();
                showToast("Nhập dữ liệu thành công!", "success");
            }
        } catch (error) {
            alert("Lỗi khi đọc file: " + error.message);
        } finally {
            event.target.value = null;
        }
    };
    reader.readAsText(file);
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && (e.target.id === 'account' || e.target.id === 'server' || e.target.id === 'current')) {
        e.preventDefault();
        addOrUpdate();
    }
});

render();

</script>

</body>
</html>
